## Redis ZSet（有序集合）使用了什么数据结构？

---

### 1. ZSet 的底层数据结构

Redis 的 ZSet（有序集合）底层采用**「跳表（Skiplist）」+「哈希表（Hashtable）」**的组合结构实现：

- **跳表（Skiplist）：**
  - 主要用于按照分数（score）有序存储成员。
  - 支持快速的范围查找、排名、区间操作等，时间复杂度 O(logN)。
  - 便于实现 ZRANGE、ZRANK、ZRANGEBYSCORE 等操作。

- **哈希表（Hashtable）：**
  - 用于通过成员名（member）快速定位分数，实现 O(1) 的查找。
  - 保证成员唯一性和分数的高效更新。

---

### 2. 为什么要双结构？

- **跳表**保证有序性和高效的区间检索。
- **哈希表**保证成员的快速定位和更新。
- 两者互补，提高了 ZSet 的整体操作效率。

---

### 3. 特殊情况：小型 ZSet

- 当 ZSet 元素数量较少且成员和分数都较小（如元素数 < 128，成员和分数长度都较小，具体阈值可配置），
  底层会采用**压缩列表（ziplist）**（Redis 5.0 以后为 listpack）以节省内存。
- 当元素数量或成员/分数变大时，自动切换为「跳表+哈希表」。

---

### 4. 总结

- **小型 ZSet：ziplist（或 listpack）**
- **普通/大型 ZSet：跳表（Skiplist）+ 哈希表（Hashtable）**

---

### 通俗理解

跳表像有多条高架桥的有序链路，查找很快；哈希表像字典，找某个人的位置特别快。两者结合，既能高效排序，又能快速定位。



## ZSet（有序集合）底层数据结构——面试官深问问题与参考答案

---

### 1. 为什么 ZSet 要同时用跳表和哈希表？能不能只用一种？

**参考答案：**  
跳表用于按照分数有序存储成员，支持高效的范围查找和排序；哈希表用于根据成员名快速定位分数，实现 O(1) 查找和删除。两者结合，既保证了有序性和区间操作性能，又保证了按成员名操作的高效，单独使用一种会影响部分操作的效率。

---

### 2. ZSet 的跳表结构是如何支持区间操作和排序的？

**参考答案：**  
跳表通过多层索引实现“跳跃式”查找，支持 O(logN) 的范围查找、插入和删除。通过分数有序排列节点，可以方便地实现 ZRANGE、ZRANGEBYSCORE、ZREMRANGEBYRANK 等区间操作和有序遍历。

---

### 3. 哈希表在 ZSet 里的作用是什么？为什么不能只用跳表？

**参考答案：**  
哈希表通过成员名（member）做键，分数（score）做值，支持 O(1) 级别的查找、更新和删除。如果只用跳表，按成员名查找、更新、删除就只能遍历所有节点，效率低下。哈希表保证了这些操作的高效性。

---

### 4. ZSet 什么时候用 ziplist（或 listpack）？何时切换为跳表+哈希表？

**参考答案：**  
当 ZSet 元素数量较少且成员/分数都较小时（如元素数 < 128，成员和分数都较短，具体阈值可配置），底层用 ziplist（或 Redis 5.0+ 的 listpack）以节省内存。当元素数量或成员/分数变大时，Redis 会自动切换为“跳表+哈希表”结构，以保证操作性能。

---

### 5. 跳表相比红黑树有哪些优缺点？为什么 Redis 没有选红黑树？

**参考答案：**  
跳表实现简单，插入和删除时无需复杂的旋转操作，而且链式结构便于内存管理和高并发扩展。虽然极端情况下跳表的最坏性能略逊于红黑树，但实际表现足够好，且实现复杂度更低。Redis 追求极致性能和易维护性，所以选择了跳表。

---

### 6. Redis 如何保证 ZSet 中成员唯一？如果添加已存在成员会发生什么？

**参考答案：**  
ZSet 通过哈希表确保每个成员名唯一。如果添加已存在的成员，Redis 会更新其分数，并在跳表中重新排序该成员的位置，保证有序性。

---

### 7. 跳表如何支持排名（rank）等操作？实现原理是什么？

**参考答案：**  
跳表的多层索引设计可支持累计访问节点数，Redis 跳表节点结构中带有“跨度”字段，可以高效地统计前面有多少个节点，从而支持 ZRANK 等排名操作，效率为 O(logN)。

---

### 8. ZSet 的空间占用如何？如何优化？

**参考答案：**  
小型 ZSet 用 ziplist（或 listpack）节省内存，大 ZSet 用跳表+哈希表会占用更多空间。可通过合理设置阈值、定期删除过期数据、只存必要信息等方式优化空间占用。

---

## 总结

面试深问时，应掌握 ZSet 底层结构设计的原因、各自优劣、自动切换机制及实际应用中的效率和空间权衡。