# 秒杀场景下如何加库存？

## 1️⃣ 背景

- 秒杀系统通常面临高并发和库存稀缺，常见考点是扣减库存，实际上加库存和扣减库存的处理方式类似。
- 典型场景：商品补货、临时追加库存等。

---

## 2️⃣ 加库存的核心原则

- **原子性**：加库存操作必须和扣减库存一样，保证原子性，避免并发冲突。
- **一致性**：Redis和数据库的库存要保持一致。
- **高并发安全**：必须能抗住高并发下的加库存操作。

---

## 3️⃣ 技术方案

### A. Redis原子加库存（推荐）

- 利用Redis天然单线程+Lua脚本的方式，实现加库存的原子操作。
- 示例Lua脚本：

```lua
local key = KEYS[1] -- 商品库存key
local amount = tonumber(ARGV[1]) -- 增加数量
redis.call('incrby', key, amount)
return redis.call('get', key)
```

- 优点：原子、并发安全、性能高。

---

### B. 数据库加库存

- 通过SQL语句实现库存的增加，利用数据库的行级锁保证并发安全。

```sql
UPDATE inventory
SET quantity = quantity + #{count}
WHERE sku_id = 'xxx';
```

- 适用于需要持久化库存的场景。

---

### C. 双写一致性（Redis+数据库）

1. **先加Redis库存**（高性能，实时响应）
2. **异步/消息队列同步数据库库存**（保证数据最终一致）
   - 如有补货需求，后台可以发起加库存请求，并通过MQ异步写库
   - 注意幂等性，避免重复加库存

---

## 4️⃣ 其他注意点

- **加多少还是加到多少**：推荐“加多少”，与扣减库存逻辑对称，易于实现幂等。
- **接口防重**：防止重复提交导致库存多加。
- **一致性保障**：Redis挂掉、MQ丢失等问题，与扣减库存时的处理类似，可用补偿机制/对账兜底。

---

## 5️⃣ 总结

- 秒杀场景下加库存，推荐用Redis+Lua原子操作，结合数据库异步同步。
- 方案和扣减库存完全一致，只是操作相反。
- 关注一致性、原子性和高并发下的安全性。

---