# 应用发布与 DDL 变更如何保证安全、不出错？

## 1️⃣ 发布顺序建议

- **先执行 DDL 变更，再发布应用代码**
    - DDL变更如：加字段、加索引等，先上线数据库变更
    - 再更新应用代码，确保新代码能兼容新表结构
- **理由**：如果先发布代码，DDL未执行，代码访问到新字段/表会报错

---

## 2️⃣ DDL 变更兼容性

- **向前兼容**：只允许“加字段/加索引”，禁止直接删字段、改字段类型
- **不建议做开关**：大部分公司规范不允许不兼容DDL变更。如果实在有需求（如灰度发布、A/B测试），可以做开关，但会极大增加代码复杂度和维护成本

---

## 3️⃣ 超大表DDL注意事项

- **避开高峰期**：DDL过程会消耗资源（CPU、IO、内存），即使是MySQL 5.6+支持Online DDL，也不建议业务高峰期执行
- **提前评估影响**：如表太大，操作时间长，建议先在测试、预生产环境验证耗时和影响
- **备份数据**：关键表DDL前先做备份，防止误操作
- **监控告警**：DDL过程中关注数据库负载、慢查询、锁等待等

---

## 4️⃣ ORM自动表结构更新风险

- **生产环境不要直接用 JPA/Hibernate 的 `ddl-auto=update`**
    - 风险：变更不可控，历史不可追溯，容易误删、误改结构
    - 复杂变更（如字段重命名/数据迁移/索引变更）都需要手写SQL
    - 变更建议全部用手写DDL脚本+变更历史记录，专人审核执行

---

## 5️⃣ 最佳实践流程

1. **DDL脚本提前编写、评审、预演**
2. **先执行DDL（加字段、加索引），确认无误**
3. **上线新代码，代码兼容新表结构**
4. **（如需删字段/索引，分两步：先下线代码，再删字段）**
5. **全程监控数据库负载，遇到异常及时回滚/处理**
6. **记录所有数据库变更历史，便于审计和回溯**

---

## 6️⃣ 总结表格

| 步骤        | 说明                                         |
| ----------- | -------------------------------------------- |
| 先DDL后代码 | 先更新数据库表结构，再发布应用代码           |
| 兼容性变更  | 只允许向前兼容DDL变更，禁止直接删字段/改类型 |
| 大表DDL     | 避开高峰、备份、监控，必要时分步执行         |
| ORM自动DDL  | 生产环境禁用自动更新，全部变更用手写脚本审查 |
| 变更记录    | 所有DDL变更需有历史记录，便于追溯和回滚      |

---