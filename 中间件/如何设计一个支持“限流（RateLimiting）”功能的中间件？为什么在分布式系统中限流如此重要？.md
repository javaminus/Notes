## 问题：如何设计一个支持“限流（Rate Limiting）”功能的中间件？为什么在分布式系统中限流如此重要？

### 详细解释

#### 1. 场景描述

设想你正在开发一个高并发的API服务，后端资源有限，突然某些用户以极高的频率请求接口，导致服务响应变慢甚至宕机。为了保护系统资源、防止滥用，就需要在系统中引入**限流中间件**。

#### 2. 限流的常见策略

- **固定窗口计数法（Fixed Window Counter）**  
  例如：每分钟最多允许100次请求，超出直接拒绝。
- **滑动窗口（Sliding Window）**  
  让统计口径更平滑，减少“边界突刺”问题。
- **令牌桶（Token Bucket）**  
  服务端定时生成令牌，请求只有拿到令牌才放行，适合突发流量场景。
- **漏桶（Leaky Bucket）**  
  类似一个漏水的桶，水（请求）只能以固定速率流出，多余的就溢出被丢弃。

#### 3. 分布式场景下的挑战

- **多节点协同**：限流状态需要跨服务节点同步（如存储在Redis）。
- **一致性问题**：如何保证每个节点感知到的“请求数”是一致的。
- **高可用**：限流服务本身也不能成为瓶颈和单点故障。

#### 4. 通俗例子

想象你在超市排队结账。收银员每分钟只能服务10个人。超过10个人必须等下一个分钟。  
如果有多个收银台（对应分布式系统的多节点），所有收银台都需要共享同一个排队系统（比如一个“中央排号机”/Redis），以确保公平和准确。

#### 5. 代码设计简单示例（伪代码）

```python
def rate_limit_middleware(request):
    key = "user:{}:minute:{}".format(request.user, get_current_minute())
    count = redis.incr(key)
    if count > LIMIT:
        return reject("请求过于频繁")
    else:
        return next_handler(request)
```

### 总结性回答/复习提示词

- **限流的作用**：防止系统过载，保障服务可用性和公平性。
- **常见算法**：固定窗口、滑动窗口、令牌桶、漏桶。
- **分布式难点**：状态一致性、性能瓶颈、数据同步。
- **场景记忆法**：把限流理解为“超市排队+中央排号机”。

> **提示词总结**：限流设计、算法选择、分布式状态同步、系统保护、真实业务场景

---