# JVM 字符串常量池（String Constant Pool）与 `intern()` 机制详解

---

## 1. 什么是字符串常量池？

- **字符串常量池**（String Constant Pool）是 JVM 专门为字符串优化分配的内存区域。
- 用于存放**字符串字面量**（如 `"abc"`）和通过 `String.intern()` 方法明确要求放入池中的字符串。
- 目的是**避免重复分配相同内容的字符串对象**，节省内存，加快字符串比较速度（比较引用即可）。

---

## 2. 字符串常量池的实现与位置

- **JDK6 及以前**：常量池在方法区（PermGen）。
- **JDK7 及以后**：常量池移到堆内存中（Heap），和普通对象一样受 GC 管理，容量变大也更灵活。

---

## 3. 字符串的创建方式与池的关系

- 直接写 `"abc"` 这样的字符串字面量，**编译期就放入常量池**。
- 用 `new String("abc")` 会在堆上新建对象，不管池，有两个对象（池中"abc"和堆上新对象）。
- 通过 `intern()` 方法可将堆对象的内容尝试放入常量池，并返回池中的引用。

---

## 4. `intern()` 方法的工作机制

- **作用**：  
  - `s.intern()` 会查找常量池中是否有内容等同于 s 的字符串。
    - 有，则返回池中引用；
    - 没有，则将 s 的内容添加到常量池，并返回引用。
- **常见用法**：
  ```java
  String s1 = new String("abc");
  String s2 = s1.intern();
  String s3 = "abc";
  System.out.println(s2 == s3); // true
  ```
- **注意**：JDK7+，如果堆上的 s 首次 intern，会把堆对象引用放入池，而不是新建对象。

---

## 5. 对内存与 GC 的影响

- **优点**：
  - 避免重复字符串对象，节省内存。
  - 字符串比较效率高（可直接用 `==` 比较引用）。
- **风险**：
  - 池中对象**生命周期长**，只有池本身被 GC 时才回收（JDK7+在堆上，可被 GC，但存活时间长）。
  - 大量动态字符串或错误使用 intern() 可能造成**堆内存溢出**（OutOfMemoryError）。
- **调优建议**：
  - 只对重复频繁出现的字符串使用 intern()，避免过度膨胀常量池。
  - 动态拼接的大字符串不宜 intern。

---

## 6. 通俗例子

```java
String a = "hello";
String b = "hello";
System.out.println(a == b); // true，引用相同，均指向常量池

String c = new String("hello");
System.out.println(a == c); // false，c是新堆对象
System.out.println(a == c.intern()); // true，c.intern()返回池中引用
```

---

## 7. 总结复习口诀

- 常量池：一份内容多处用，省内存
- intern()：池里有就用，没有就存
- 池在堆：JDK7+生命周期长，慎放大对象
- 口诀：“字符串池省空间，intern用要慎，大量动态别乱存”

---

## 8. 面试官可能追问及参考答案

### Q1：字符串常量池和普通对象有什么不同？
**答：**  
常量池中的字符串是全局唯一的，同值只存一份，且生命周期长。普通字符串对象在堆中，可以有多个内容一样但引用不同的对象。

---

### Q2：JDK6 和 JDK7 的字符串常量池实现有何区别？
**答：**  
JDK6 常量池在 PermGen 区，容量有限且不易 GC；JDK7+ 移到堆上，空间大且可 GC，但池中对象生命周期依然较长。

---

### Q3：`intern()` 会不会造成内存泄漏？
**答：**  
会。频繁对不同内容的字符串调用 intern() 会导致常量池膨胀，尤其是处理大量动态字符串（如用户输入、日志），可能导致堆 OOM。

---

### Q4：实际开发中什么时候用 `intern()`？
**答：**  
只有在确定某类字符串重复率极高、节省内存效果明显时使用，如数据库表名、枚举、协议关键字等。不要对动态、大量唯一字符串使用。

---

### Q5：字符串常量池的对象什么时候能被 GC？
**答：**  
JDK7+ 常量池在堆上，只要池中对象没有强引用且池本身被 GC 扫描到，才可能被回收。但通常池对象存活很久，需谨慎管理。

---