### Redis ä¸­çš„è·³è¡¨ï¼ˆSkip Listï¼‰

#### 1. **è·³è¡¨æ˜¯ä»€ä¹ˆï¼Ÿ**

è·³è¡¨ï¼ˆSkip Listï¼‰æ˜¯ä¸€ç§ **åŸºäºé“¾è¡¨çš„æœ‰åºæ•°æ®ç»“æ„**ï¼Œé€šè¿‡**å¤šçº§ç´¢å¼•**æ¥åŠ é€ŸæŸ¥è¯¢ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥å¤šçº§ç´¢å¼•ï¼Œä½¿å¾—æŸ¥æ‰¾æ•ˆç‡ä» O(n) é™ä½åˆ° O(log n)ã€‚

#### 2. **Redis ä¸ºä»€ä¹ˆä½¿ç”¨è·³è¡¨ï¼Ÿ**

åœ¨ Redis ä¸­ï¼Œè·³è¡¨è¢«ç”¨äºå®ç° **æœ‰åºé›†åˆï¼ˆSorted Setï¼Œzsetï¼‰**ï¼Œç‰¹åˆ«æ˜¯å½“ï¼š

- éœ€è¦èŒƒå›´æŸ¥è¯¢ï¼ˆä¾‹å¦‚ `ZRANGE`ï¼‰
- éœ€è¦æŒ‰åˆ†æ•°æ’åºï¼ˆscoreï¼‰
- éœ€è¦é«˜æ•ˆæ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œ

ç›¸æ¯”äº **çº¢é»‘æ ‘**ï¼Œè·³è¡¨å®ç°æ›´ç®€å•ï¼Œæ€§èƒ½ç›¸å½“ï¼Œå¹¶ä¸”æ”¯æŒ**é¡ºåºæ€§æŸ¥è¯¢**ï¼Œå› æ­¤è¢« Redis é‡‡ç”¨ã€‚

#### 3. **è·³è¡¨çš„ç»“æ„**

è·³è¡¨çš„ç»“æ„ç±»ä¼¼äºå¤šä¸ªå±‚å çš„é“¾è¡¨ï¼š

- **åº•å±‚** æ˜¯ä¸€ä¸ªæ™®é€šçš„æœ‰åºé“¾è¡¨
- **ä¸Šå±‚** æ˜¯ç´¢å¼•å±‚ï¼Œæ¯ä¸€å±‚çš„å…ƒç´ æ˜¯ä¸‹å±‚å…ƒç´ çš„å­é›†ï¼Œæä¾›è·³è·ƒè®¿é—®èƒ½åŠ›
- **å¤´ç»“ç‚¹** è¿æ¥æ‰€æœ‰ç´¢å¼•å±‚ï¼Œæœ€é«˜ç´¢å¼•å±‚å¯ä»¥å¿«é€Ÿè·³è·ƒåˆ°è¿œå¤„çš„å…ƒç´ 

ä¾‹å¦‚ï¼š

```
Level 3:     [4] ---------> [16] -------> [32]
Level 2:     [4] ----> [8] ----> [16] --> [24] --> [32]
Level 1: [1] -> [4] -> [6] -> [8] -> [12] -> [16] -> [20] -> [24] -> [28] -> [32]
```

#### 4. **è·³è¡¨æ“ä½œçš„æ—¶é—´å¤æ‚åº¦**

- **æŸ¥è¯¢ï¼ˆæŸ¥æ‰¾æŸä¸ªå…ƒç´ ï¼‰**ï¼šO(log n)
- **æ’å…¥**ï¼šO(log n)
- **åˆ é™¤**ï¼šO(log n)
- **èŒƒå›´æŸ¥è¯¢**ï¼šO(log n + k)ï¼ˆk æ˜¯æŸ¥è¯¢èŒƒå›´å†…çš„å…ƒç´ ä¸ªæ•°ï¼‰

#### 5. **Redis ä¸­çš„è·³è¡¨å®ç°**

Redis ä½¿ç”¨ `zskiplist` ç»“æ„æ¥å®ç°è·³è¡¨ï¼Œå…¶ä¸­ï¼š

- **èŠ‚ç‚¹ï¼ˆzskiplistNodeï¼‰** å­˜å‚¨ `score`ï¼ˆåˆ†æ•°ï¼‰ å’Œ `obj`ï¼ˆæˆå‘˜å€¼ï¼‰
- **å¤´ç»“ç‚¹ï¼ˆheaderï¼‰** å­˜å‚¨å¤šä¸ªç´¢å¼•å±‚
- **å°¾ç»“ç‚¹ï¼ˆtailï¼‰** ä¾¿äºä»å³å‘å·¦éå†
- **éšæœºå±‚çº§åˆ†é…** é‡‡ç”¨ **å¹‚æ¬¡æ³•**ï¼ˆ1/2 æ¦‚ç‡æ–°å¢ä¸€çº§ï¼‰

æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š

```
typedef struct zskiplistNode {
    sds ele;              // æˆå‘˜å€¼
    double score;         // åˆ†æ•°
    struct zskiplistNode *backward; // åé€€æŒ‡é’ˆï¼ˆç”¨äºå€’åºéå†ï¼‰
    struct zskiplistLevel {
        struct zskiplistNode *forward; // å‰è¿›æŒ‡é’ˆ
        unsigned int span;             // è·¨è¶Šçš„æ­¥é•¿
    } level[];
} zskiplistNode;

typedef struct zskiplist {
    struct zskiplistNode *header, *tail; // å¤´å°¾æŒ‡é’ˆ
    unsigned long length;  // é•¿åº¦
    int level;             // å½“å‰æœ€é«˜å±‚æ•°
} zskiplist;
```

#### 6. **Redis ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å¹³è¡¡æ ‘ï¼Ÿ**

- **è·³è¡¨ä»£ç å®ç°æ¯”å¹³è¡¡æ ‘ç®€å•**
- **è·³è¡¨æ”¯æŒé¡ºåºéå†ï¼Œè€Œçº¢é»‘æ ‘åªèƒ½ä¸­åºéå†**
- **Redis çš„æœ‰åºé›†åˆç»å¸¸éœ€è¦èŒƒå›´æŸ¥è¯¢ï¼Œè·³è¡¨æ›´é«˜æ•ˆ**
- **è·³è¡¨çš„æ’å…¥ã€åˆ é™¤ä¸ä¼šè§¦å‘å¤æ‚çš„æ ‘ç»“æ„è°ƒæ•´**

#### 7. **æ€»ç»“**

- Redis ç”¨è·³è¡¨ï¼ˆskip listï¼‰å®ç° **zset**ï¼Œå› ä¸ºå®ƒæ¯”çº¢é»‘æ ‘æ›´é€‚åˆèŒƒå›´æŸ¥è¯¢å’Œé¡ºåºè®¿é—®
- è·³è¡¨é€šè¿‡ **å¤šçº§ç´¢å¼•** å®ç° **O(log n) çš„æŸ¥æ‰¾æ•ˆç‡**
- Redis çš„ `zskiplist` ç»“æ„ä½¿ç”¨ **éšæœºå±‚çº§åˆ†é…**ï¼Œæé«˜è®¿é—®é€Ÿåº¦
- åœ¨ Redis é‡Œï¼Œ**zset ç”±è·³è¡¨ + å“ˆå¸Œè¡¨ ç»„æˆ**ï¼Œå“ˆå¸Œè¡¨ç”¨äº O(1) å¿«é€Ÿå®šä½ï¼Œè·³è¡¨ç”¨äºèŒƒå›´æŸ¥è¯¢

å¦‚æœä½ è¦æ·±å…¥ç ”ç©¶ Redis æºç ï¼Œå¯ä»¥ä» `zskiplist.c` å¼€å§‹åˆ†æï¼ğŸš€