# 百万级会员平台实现快到期会员消息提醒的方案设计

---

## 1. 快到期会员的高效筛选

- **会员表设计**：需包含 `expire_time` 字段，并对其建立索引。
- **筛选SQL**（避免函数，走索引）：
  ```sql
  SELECT user_id FROM member WHERE expire_time BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 3 DAY);
  ```
- **不需要分库分表/分区/冷热分离**：百万级数据索引足够，无需复杂设计。

---

## 2. 高效推送消息

- **定时任务批量扫描**：
  - 可用分布式任务调度框架（如XXL-JOB），利用分片并发扫描，提高处理效率。
  - 例如按 user_id 尾号分片，10台机器并发处理百万数据，批量拉取待提醒用户。

- **消息异步推送**：
  - 扫描出的用户ID推送到MQ（消息队列）中，由消息消费者异步进行消息推送，解耦推送与主流程。
  - 支持多线程/批量推送，提升吞吐量。

---

## 3. 消息推送方式及渠道

- 支持多渠道通知：短信、邮件、APP推送、站内信、电话等。
- 推送渠道可配置，支持优先级、限流、降级、熔断等稳定性保障措施。
- 注意第三方接口限流和高并发容错。

---

## 4. 推送记录落表

- 设计消息推送表，字段如下：

| 字段名       | 描述                           |
| ------------ | ------------------------------ |
| id           | 主键，自增                     |
| user_id      | 接收用户ID                     |
| message_type | 消息类型（如到期提醒）         |
| channel      | 推送渠道（短信/邮件/APP等）    |
| content      | 消息内容                       |
| status       | 状态（待发送、已发送、失败等） |
| send_time    | 实际发送时间                   |
| retry_count  | 重试次数                       |
| error_info   | 失败详情                       |
| create_time  | 创建时间                       |
| update_time  | 更新时间                       |
| third_msg_id | 第三方渠道返回ID               |
| is_read      | 是否已读（如站内信）           |
| click_time   | 用户点击时间                   |
| extra_info   | 扩展字段（如模板参数）         |

- 支持幂等控制、疲劳度控制、失败重试、数据分析和监控。

---

## 5. 防疲劳推送（避免频繁提醒）

- 可用Redis做防疲劳控制：
  - 发送前先检查 `user_id:message_type` 键是否存在，24小时内存在则不再推送。
  - 发送后设置该Key，过期时间24小时，避免重复提醒。
- 配置推送时段，禁止夜间、节假日等特殊时间段推送。
- 配合业务规则灵活调整。

---

## 6. 异常处理与数据归档

- **失败重试**：基于消息表状态，定期重试失败消息，重试次数达到阈值后不再重试并报警。
- **监控告警**：异常推送、批量失败自动告警，便于及时人工介入。
- **数据归档**：历史推送数据定期归档，减小主表体量，提升查询性能。

---

## 7. 典型流程总结

1. 定时任务高效筛选即将到期用户（走expire_time索引，分片并发）。
2. 批量推送user_id到消息队列，推送服务异步消费处理。
3. 推送前查Redis做疲劳度控制。
4. 按渠道推送消息，状态落表，按需重试、归档、监控。

---

> 💡 **一句话总结：百万级会员到期提醒，核心在于到期时间索引筛选+分布式异步推送+防疲劳控制+落表幂等重试+监控告警，整体流程简单高效、可扩展，完全不需要复杂的分库分表设计。**