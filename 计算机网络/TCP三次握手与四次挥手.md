# TCP 三次握手与四次挥手详解

## 一、TCP三次握手（Three-way Handshake）

### 目的
建立可靠的连接，保证双方收发能力正常。

### 过程详解

1. **第一次握手（SYN）**
   - 客户端发送SYN包（SYN=1, seq=x）到服务器，进入SYN_SEND状态，表示希望建立连接。

2. **第二次握手（SYN-ACK）**
   - 服务器收到SYN后，回复SYN+ACK包（SYN=1, ACK=1, seq=y, ack=x+1），进入SYN_RCVD状态。

3. **第三次握手（ACK）**
   - 客户端收到SYN+ACK后，回复ACK包（ACK=1, seq=x+1, ack=y+1），进入ESTABLISHED状态，服务器收到ACK后也进入ESTABLISHED状态，连接建立成功。

```
客户端                       服务器
  | ---------SYN(x)--------> |
  | <-----SYN(y)ACK(x+1)---- |
  | ---------ACK(y+1)------> |
```

---

## 二、TCP四次挥手（Four-way Handshake）

### 目的
可靠地断开连接，确保数据传输完成。

### 过程详解

1. **第一次挥手（FIN）**
   - 主动关闭方发送FIN包（FIN=1, seq=u），进入FIN_WAIT_1状态。

2. **第二次挥手（ACK）**
   - 被动方收到FIN，回复ACK包（ACK=1, seq=v, ack=u+1），进入CLOSE_WAIT状态，主动方收到ACK后进入FIN_WAIT_2状态。

3. **第三次挥手（FIN）**
   - 被动方准备关闭连接时，发送FIN包（FIN=1, seq=w），进入LAST_ACK状态。

4. **第四次挥手（ACK）**
   - 主动方收到FIN后，回复ACK包（ACK=1, seq=u+1, ack=w+1），进入TIME_WAIT状态，等待2MSL后进入CLOSED状态。被动方收到ACK后进入CLOSED状态。

```
主动关闭方                   被动关闭方
  | ---------FIN(u)--------> |
  | <--------ACK(u+1)------- |
  | <--------FIN(w)--------- |
  | ---------ACK(w+1)------> |
```

---

## 三、面试高频追问与参考答案

### 1. **为什么三次握手不是两次？**

**答：**
两次握手无法保证客户端和服务器的收发能力都正常。三次握手可以确认：
- 客户端能发、能收（第二次握手收到SYN+ACK）
- 服务器能发、能收（第三次握手收到ACK）

### 2. **为什么四次挥手不是三次？**

**答：**
TCP是全双工通信，双方都要单独关闭自己的发送通道。被动方收到FIN后，可能还有数据未发送完，所以需要分开发送ACK和FIN。

### 3. **TIME_WAIT状态存在的原因？**

**答：**
- 保证最后一个ACK能让对方收到，防止丢失导致对方无法正常关闭。
- 防止旧连接的重复报文影响新连接。

### 4. **SYN攻击是什么？如何防御？**

**答：**
**SYN攻击**：攻击者发送大量SYN请求但不回应服务器的SYN-ACK，导致服务器资源耗尽。
**防御措施**：
- SYN Cookie技术
- 限制半连接数量和超时时间

### 5. **三次握手过程中能携带数据吗？**

**答：**
- 客户端第三次握手可以携带数据，前两次不建议携带。
- 服务器在第二次回复SYN+ACK时一般不携带数据。

### 6. **CLOSE_WAIT状态过多的原因？**

**答：**
- 说明服务器没有及时关闭连接，通常是程序未调用close()，需检查业务逻辑。

---

## 四、扩展知识点

- **RST包的作用**：强制关闭连接。
- **为什么需要MSL（最大报文生存时间）？**：确保旧报文不会影响新连接，保证连接可靠关闭。
- **连接建立与断开状态机图**：建议面试前画一遍，加深理解。

---

> 面试时，建议结合实际场景和状态机图解释，可以加分。