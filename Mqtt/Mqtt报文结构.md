## MQTT 报文结构与 PUBLISH 报文举例

### 一、MQTT 报文结构总览

每个MQTT报文由三部分组成：

1. **固定报头（Fixed Header）**  
   每个MQTT报文都必须有，至少2字节。
2. **可变报头（Variable Header）**  
   根据报文类型决定是否存在。
3. **有效载荷（Payload）**  
   部分报文需要，内容结构依类型而异。

> 为什么固定报头至少四个字节？
>
> 
>
> 这是因为**MQTT协议规定，每个报文的固定报头必须包含两部分信息：**
>
> 1. **报文类型和标志位（第1字节，8位）**  
>    - 前4位：表示报文类型（如CONNECT、PUBLISH等）
>    - 后4位：用于标志（如DUP、QoS、RETAIN等）
>
> 2. **剩余长度（Remaining Length，1~4字节）**  
>    - 这个字段说明“可变报头+有效载荷”的总长度。
>    - 剩余长度至少1字节（如果后续内容长度小于128），最大可扩展到4字节（采用变长编码方式）。
>
> **因此：**
> - 固定报头**最少**包括**1字节的报文类型和标志位**，加上**1字节的剩余长度**，合计2字节。
> - 如果剩余长度非常大，固定报头会扩展到最多5字节，但“至少”2字节是协议的硬性要求。
>
> ---
>
> **总结：**  
> 因为需要表达报文类型和剩余长度，MQTT的固定包头至少2字节。这是协议格式决定的。

---

#### 1. 固定报头（Fixed Header）

- **第1字节（8位）：**
  - 前4位：报文类型（Message Type），如CONNECT、PUBLISH等
  - 后4位：标志位（Flags），如DUP，QoS，RETAIN等

- **第2字节及之后（1~4字节）：**
  - 剩余长度（Remaining Length），表示后续所有数据的总长度（可变长度编码）

#### 2. 可变报头（Variable Header）

- 某些报文需要（如CONNECT、PUBLISH、SUBSCRIBE等）。
- 可能包含协议名、版本号、标志、主题名、报文标识符等。

#### 3. 有效载荷（Payload）

- 实际传输数据内容。
- 仅在部分报文（如PUBLISH、CONNECT、SUBSCRIBE）中存在。

---

### 二、MQTT 常见报文类型

| 报文类型编号 | 报文名称    | 用途             |
| ------------ | ----------- | ---------------- |
| 1            | CONNECT     | 连接请求         |
| 2            | CONNACK     | 连接确认         |
| 3            | PUBLISH     | 发布消息         |
| 4            | PUBACK      | 发布确认QoS 1    |
| 5            | PUBREC      | 发布收到QoS 2    |
| 6            | PUBREL      | 发布释放QoS 2    |
| 7            | PUBCOMP     | 发布完成QoS 2    |
| 8            | SUBSCRIBE   | 订阅请求         |
| 9            | SUBACK      | 订阅确认         |
| 10           | UNSUBSCRIBE | 取消订阅         |
| 11           | UNSUBACK    | 取消订阅确认     |
| 12           | PINGREQ     | 心跳请求         |
| 13           | PINGRESP    | 心跳响应         |
| 14           | DISCONNECT  | 断开连接         |
| 15           | AUTH        | 认证（MQTT 5.0） |

---

### 三、PUBLISH 报文举例

假设我们要发送一个主题为 `test/topic`，消息内容为 `hello`，QoS 0 的 PUBLISH 报文：

#### 1. 固定报头

- 第1字节：0x30  
  - 0011 0000  
    - 0011：PUBLISH 类型
    - 后四位0：QoS 0，非保留/非DUP
- 第2字节：0x0e  
  - 剩余长度（14字节，等于可变报头+载荷长度）

#### 2. 可变报头

- 主题名长度：0x00 0x0a（2字节，十进制10）
- 主题名：`test/topic`（10字节）

#### 3. 有效载荷

- 内容：`hello`（5字节）

---

#### 组装后的16进制数据

| 字节序号 | 内容                          | 说明             |
| -------- | ----------------------------- | ---------------- |
| 0        | 0x30                          | 固定报头         |
| 1        | 0x0e                          | 剩余长度14       |
| 2        | 0x00                          | 主题长度高字节   |
| 3        | 0x0a                          | 主题长度低字节10 |
| 4-13     | 74 65 73 74 2f 74 6f 70 69 63 | 主题'test/topic' |
| 14-18    | 68 65 6c 6c 6f                | 消息'hello'      |

---

#### 可视化结构

```
+--------------+---------------------+----------------+
| 固定报头     | 可变报头            | 有效载荷       |
+--------------+---------------------+----------------+
| 0x30 0x0e    | 0x00 0x0a           | 68 65 6c 6c 6f |
|              | t e s t / t o p i c |   h  e  l  l  o|
+--------------+---------------------+----------------+
```

---

#### 说明

- **固定报头**：`0x30 0x0e`  
- **可变报头**：主题长度2字节+主题内容10字节（`test/topic`）
- **有效载荷**：消息内容`hello`（5字节）

---

如需其他报文例子或详细字段说明，欢迎继续提问！