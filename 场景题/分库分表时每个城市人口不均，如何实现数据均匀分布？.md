# 分库分表时每个城市人口不均，如何实现数据均匀分布？🏙️🏞️

这是分库分表中典型的数据倾斜问题，核心是**分表字段不均匀导致单表压力大**。解决思路如下：

---

## 1️⃣ 更换分表键或分表算法 🔄

- **避免直接用城市字段作为分表键**，因为人口分布本身不均。
- 若业务允许，可选择更均匀的字段（如用户ID、手机号hash、出生月份等）进行分表，实现负载均衡。

---

## 2️⃣ 人工干预分表算法 🧠

当业务要求必须“按城市分表”时，需对算法手动干预，常见两种方案：

### 方式一：人口密集型城市单独分表

- 人口大城市（如北京、上海、广州、深圳等）**每个城市单独分表**，其余城市共用若干张表。
- 示例伪代码：

```java
if (人口密集型城市) {
    if (北京) return "table_0000";
    if (上海) return "table_0001";
    // ...
} else {
    int idx = 城市ID % 4 + 4;
    return "table_" + idx;
}
```

- 这样大城市不影响其它城市的分表均匀性。

### 方式二：密集型城市二次拆分

- 对于人口密集型城市，还可以**再按城市下级区县拆分**，如“城市ID+区ID”取模。
- 示例伪代码：

```java
if (非人口密集型城市) {
    int idx = 城市ID % 8;
    return "table_" + idx;
} else {
    int idx = (城市ID + 区ID) % 8;
    return "table_" + idx;
}
```

- 这样北京、上海等城市的数据也能均摊到多张表。

---

## ⚠️ 不推荐做法

- **轮询分表**：插入时轮询分表无法查询时定位，查询效率低，不可取！

---

## ✅ 总结

- 选用**均匀分布的分表键**（如用户ID）最简单。
- **必须按城市分表时，结合人工干预**，对大城市单独分表或二次拆分，实现整体均衡。
- 分表算法需兼顾查询和写入的可控性与高效性。

---

> 只要提前设计好分表策略，数据倾斜问题就能有效避免，实现高性能、高可用的分库分表架构！🚀