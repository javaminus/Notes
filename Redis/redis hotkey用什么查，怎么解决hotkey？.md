## Redis Hot Key（热点 Key）用什么查？怎么解决 Hot Key？

---

### 一、如何查找 Redis Hot Key？

1. **慢查询日志（SLOWLOG）**
   - 查看 SLOWLOG，关注频繁出现的 key，通常热点 key 会频繁出现在慢查询中。

2. **监控工具**
   - 使用如 Redis 自带的 `MONITOR` 命令（线上慎用，会影响性能），可抓取实时访问的 key。
   - 推荐用 [redis-cli --hotkeys](https://redis.io/docs/latest/develop/hotkeys/) 工具（Redis 4.0+ 支持）扫描热 key：
     ```
     redis-cli --hotkeys -a <password> -h <host> -p <port>
     ```
     该命令会采样一段时间内被访问次数最多的 key。

3. **业务侧埋点统计**
   - 应用层对 Redis 操作做埋点统计，分析哪些 key 访问频率最高。

4. **第三方可视化监控**
   - 如阿里云云监控、腾讯云、Prometheus+Grafana 等，抓取 Redis QPS、命中率、key 频率分布。

---

### 二、如何解决 Redis Hot Key 问题？

1. **热点 Key 拆分（分片）**
   - 对热点 key 进行 hash 或按业务特征拆分为多个 key（如加 userId、时间戳等），分散访问压力。

2. **本地缓存（local cache）+ Redis 结合**
   - 热点数据先查本地缓存，减少 Redis 访问压力，常用如 Caffeine/Guava Cache。

3. **限流与降级**
   - 对访问频率极高的 key 做限流、请求排队或降级处理，保护 Redis。

4. **冷热数据分层缓存**
   - 热点数据放本地或更快的缓存层，长尾数据走 Redis，分散压力。

5. **异步更新/批量处理**
   - 对热点 key 的更新操作采用异步批处理，减少高并发单点写入。

6. **合理设置过期时间**
   - 不同 key 设置不同的过期时间，避免热点 key 同时失效导致缓存击穿。

7. **使用 Lua 脚本原子操作**
   - 对热点操作用 Lua 保证原子性，减少并发冲突。

---

### 三、总结

- **查找 hotkey** 推荐用 `redis-cli --hotkeys` 工具、监控采样、业务埋点等方式。
- **解决 hotkey** 主要靠热点 key 拆分、本地缓存、限流降级、冷热分层、异步批处理等技术手段。
- 生产环境应重点监控和预警热点 key，防止因单点高并发拖垮整个 Redis 服务。

---

#### 面试延伸

- 热点 key 问题本质是高并发读写集中在单点，答题时要说明原理、查找方法和多种优化方案，并能结合业务实际给出具体拆分策略。

## Redis Hot Key 问题——面试官深问问题与参考答案

---

### 1. 什么是 Hot Key？和大 Key 有什么区别？

**参考答案：**  
Hot Key（热点 Key）是指在一段时间内被大量访问、请求集中的 Key，容易导致单点压力很大。大 Key 指的是 Value 很大、成员很多的 Key。Hot Key 是“访问量”高，大 Key 是“数据量”大。

---

### 2. 如何排查和定位 Redis 的 Hot Key？

**参考答案：**  
可以使用 `redis-cli --hotkeys` 工具采样，找出访问频率最高的 Key；或者在业务侧埋点统计 Key 的访问次数；还可以通过 Redis 的慢查询日志（SLOWLOG）、监控 QPS、命中率波动等手段分析热点 Key。

---

### 3. Hot Key 会带来哪些风险？

**参考答案：**  
Hot Key 会导致 Redis 某个实例或分片负载过高，出现响应变慢、CPU 飙升，甚至阻塞其它请求。极端情况下，可能引发 Redis 雪崩，影响整体可用性。

---

### 4. 如何解决或缓解 Hot Key 问题？

**参考答案：**  
- 对热点 Key 进行分片（如加前缀 hash 拆分多个 Key）  
- 结合本地缓存，热点数据优先走本地，减少 Redis 负载  
- 对热点 Key 的访问做限流和降级  
- 错开热点 Key 的过期时间，防止同时失效  
- 对写操作采用异步批处理，减少瞬时压力

---

### 5. Hot Key 问题在集群环境下表现如何？

**参考答案：**  
集群环境下，热点 Key 所在分片节点负载会明显高于其它节点，甚至成为全局瓶颈，影响整个集群的可用性和性能。

---

### 6. 在业务设计阶段如何预防 Hot Key？

**参考答案：**  
设计时避免单一 Key 承载过多流量，合理拆分数据结构，监控 Key 访问分布，及时预警和拆分热点 Key；同时采用多级缓存架构，热点数据优先走本地缓存或 CDN。

---

### 7. 如果热点 Key 失效会发生什么，如何防止缓存击穿？

**参考答案：**  
热点 Key 失效会导致大量请求瞬间回源数据库，可能拖垮后端。可以通过互斥锁（如分布式锁）或设置热点 Key 永不过期、定时异步刷新内容来防止击穿。

---

### 8. 如果不能修改业务代码，如何临时缓解 Hot Key？

**参考答案：**  
可以增加本地缓存缓冲层，临时分流请求；临时扩容 Redis 实例；对热点 Key 加限流、降级保护，确保服务稳定。

---

### 9. 如何自动发现新的 Hot Key，并及时预警？

**参考答案：**  
业务侧应埋点统计 Key 访问频率，或结合监控平台采集 Redis 命中率、慢查询日志、QPS 和热点 Key 访问分布，自动发现并预警。

---

### 10. 热点 Key 的典型业务场景有哪些？

**参考答案：**  
如热点商品库存、热门新闻详情、排行榜前几名、全局配置、热门用户 Session 等，都是热点 Key 的高发场景。

---



