# Redis实现分布式锁，加锁时Redis不可用怎么办？

当 Redis 作为分布式锁服务挂掉时，整个系统的加锁、解锁操作都会受到影响，导致业务流程卡住、不可用。虽然生产环境多采用 Redis 集群/哨兵高可用方案，但面试或极端场景下，依然要考虑容灾和降级处理。

---

## 1️⃣ 典型降级方案

### 方案一：降级为本地锁

- **原理**：当 Redis 分布式锁失效时，自动切换为单机的本地锁（如 `ReentrantLock`、`synchronized`）。
- **优点**：保证单机服务可用，避免整体业务崩溃。
- **缺点**：无法保障分布式全局互斥（一致性牺牲，优先可用性）。
- **适用场景**：可以容忍偶发多实例并发的业务，如底层有乐观锁/数据库锁/唯一索引兜底。

### 方案二：降级为其他分布式锁（如 Zookeeper/数据库锁）

- **原理**：Redis 挂掉后，切换到 Zookeeper、数据库等其他分布式锁方案。
- **优点**：仍能保证全局互斥。
- **缺点**：实现成本高、复杂度大，并且 Redis 挂掉时已有锁状态无法同步。
- **适用场景**：对全局一致性要求极高的核心业务。

---

## 2️⃣ 降级实现方式

### 方式一：手动切换

- 通过配置中心等手段，动态调整锁实现方式。
- 示例代码：
    ```java
    if (useRedisLock) {
        // 使用Redis分布式锁
    } else {
        // 使用降级锁
    }
    ```

### 方式二：自动降级

- 代码中自动重试获取 Redis 锁，失败则自动降级为本地锁。
- 示例代码：
    ```java
    boolean lockAcquired = false;
    for (int i = 0; i < RETRY_COUNT; i++) {
        lockAcquired = tryRedisLock();
        if (lockAcquired) break;
        Thread.sleep(RETRY_DELAY);
    }
    if (!lockAcquired) {
        // 降级为本地锁
    } else {
        // 成功获取Redis锁
    }
    ```

---

## 3️⃣ 高可用保障

- 生产环境建议采用 Redis 集群、主从、哨兵等高可用架构，极大降低单点失效概率。
- 但面试/极端场景下，可以从降级的角度答题。

---

## 4️⃣ 总结

- Redis 挂掉后，优先保证应用可用性，牺牲部分一致性。
- 实现降级可手动切换或自动检测。
- 业务核心对一致性要求极高时，可选用其他分布式锁方案。

> 💡 **最佳实践：主业务依赖Redis锁时，务必考虑高可用和降级兜底，保证系统健壮性！**