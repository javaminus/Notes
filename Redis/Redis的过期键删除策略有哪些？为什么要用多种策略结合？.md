**问题：Redis的过期键删除策略有哪些？为什么要用多种策略结合？**

**详细解释（结合场景，通俗例子）：**  
Redis中的Key过期后，并不会被立刻删除，而是采用了三种策略结合的方式，主要目的是在保证内存可控的同时，避免对服务器性能造成较大影响。

1. **惰性删除（Lazy Deletion）**  
   每次访问key时，如果发现已经过期，则立即删除。不访问的key不会主动检查和删除。
   - **场景**：用户查询某个缓存key，发现已过期，Redis才真正将其删除。
   - **优点**：开销小，不影响正常请求。
   - **缺点**：如果key长期不被访问，可能一直占用内存。
2. **定期删除（Scheduled Deletion）**  
   Redis周期性随机抽取一部分设置了过期时间的key，检查并删除已过期的key。
   - **场景**：后台线程每隔一段时间扫描部分key，删除过期数据。
   - **优点**：定期清理，减少内存泄露。
   - **缺点**：如果设置不合理，可能导致过期key清理不及时或影响性能。

3. **内存淘汰（Eviction when out of memory）**  
   当内存达到上限时，根据配置的淘汰策略（如LRU、LFU等），主动淘汰部分key，包括过期key和未过期key。
   - **场景**：缓存压力大，内存紧张时，系统会优先淘汰过期key。
   - **优点**：保障Redis服务可用，防止OOM（内存溢出）。

**通俗例子：**  
就像冰箱放置食物：  
- 惰性删除是你每次拿东西发现“过期了”才扔掉；
- 定期删除是你每隔几天主动检查冰箱，把过期的东西清理掉；
- 内存淘汰是冰箱实在装不下了，不管新鲜不新鲜都得清出一部分腾地方。

**总结性回答/提示词：**  
Redis 过期键删除采用惰性删除+定期删除+内存淘汰三种策略结合，兼顾性能和内存利用。



## Redis 过期键删除策略——面试官深问问题与参考答案

---

### 1. 为什么 Redis 不直接在 key 过期时立刻删除？

**参考答案：**  
如果每个 key 到期都立即删除，会引发大量定时任务，极大消耗 CPU 资源，影响主线程性能。尤其是大并发和大量 key 场景，实时过期处理会导致严重卡顿和阻塞。因此采用“惰性+定期”结合，兼顾性能和资源利用。

---

### 2. 惰性删除和定期删除分别适合什么场景？如果只用其中一种会怎样？

**参考答案：**  
惰性删除适合高频访问场景，节省资源，不影响主流程。但对于很久不被访问的过期 key，会长期占用内存。定期删除可及时清理不活跃的过期 key，但会有额外的性能消耗。如果只用惰性，易内存泄漏；只用定期，易引发性能波动。

---

### 3. 内存淘汰和过期删除有什么区别？什么时候触发？

**参考答案：**  
内存淘汰是内存紧张、达到 maxmemory 限制时触发，优先淘汰过期 key，再按策略（如 LRU、LFU 等）淘汰其它 key。而过期删除（惰性/定期）是针对有设置过期时间的 key，即使内存没满也会清理。

---

### 4. 定期删除的参数能否调整？如何影响性能？

**参考答案：**  
可以调整定期删除的频率和每次扫描 key 的数量。频率高、每次清理多会更及时，但会占用更多 CPU，影响响应。频率低、数量少则易积压过期 key，导致内存占用上升。需根据业务和资源灵活配置。

---

### 5. Redis 如何保证最终所有过期 key 都能被删除？

**参考答案：**  
通过惰性删除保证被访问的 key 及时删除，定期删除补充未访问的过期 key，内存淘汰机制兜底。在极端情况下（如长期不被访问且定期抽查没命中），部分 key 可能短暂残留，但最终会被删除，保证内存可控。

---

### 6. 如果一个 key 设置了过期时间，但一直不被访问，会发生什么？

**参考答案：**  
该 key 不会被惰性删除，但会被定期删除机制随机抽查出来删除，或者在内存紧张时被优先淘汰。

---

### 7. Redis 的过期 key 删除策略为什么要三者结合？能否只用一种？

**参考答案：**  
三种策略各有优缺点，结合使用能兼顾性能、内存利用和系统可用性。只用其中一种会导致内存泄露或性能抖动，不适合生产环境。

---

### 8. 如何监控和优化过期 key 的删除效果？

**参考答案：**  
可通过 `INFO stats` 里的 `expired_keys`、`evicted_keys` 监控删除和淘汰量，结合慢日志和指标分析定期清理参数，调整内存策略，优化系统表现。

---

### 9. Redis 删除过期 key 的操作是否会阻塞主线程？

**参考答案：**  
惰性删除和定期删除大多为轻量操作，不会长时间阻塞主线程。但极端情况下（如大 key 删除），可能造成短暂阻塞。6.0+ 版本支持异步删除（UNLINK）减少影响。

---

### 10. 有哪些业务场景要特别关注过期 key 的删除策略？

**参考答案：**  
大并发缓存系统、延时任务队列、Session 管理、消息队列等依赖大量 key 过期的场景，必须合理配置和监控删除策略，否则易引发内存泄漏或 OOM 问题。

---