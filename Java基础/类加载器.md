### **ç±»åŠ è½½å™¨è¿‡ç¨‹ï¼ˆClassLoaderï¼‰**
åœ¨ Java ä¸­ï¼Œ**ç±»çš„åŠ è½½** ç”± **ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰** è´Ÿè´£ï¼Œä¸»è¦åŒ…æ‹¬**åŠ è½½ï¼ˆLoadingï¼‰ã€é“¾æ¥ï¼ˆLinkingï¼‰ã€åˆå§‹åŒ–ï¼ˆInitializationï¼‰** è¿™å‡ ä¸ªé˜¶æ®µã€‚

---

## **1. ç±»åŠ è½½è¿‡ç¨‹**
ç±»çš„åŠ è½½è¿‡ç¨‹åˆ†ä¸º **äº”ä¸ªé˜¶æ®µ**ï¼š
1. **åŠ è½½ï¼ˆLoadingï¼‰**
2. **éªŒè¯ï¼ˆVerificationï¼‰**
3. **å‡†å¤‡ï¼ˆPreparationï¼‰**
4. **è§£æï¼ˆResolutionï¼‰**
5. **åˆå§‹åŒ–ï¼ˆInitializationï¼‰**

**ç¤ºæ„å›¾ï¼š**
```
Java æºç  â†’ ç¼–è¯‘æˆ .class æ–‡ä»¶ â†’ ç±»åŠ è½½å™¨åŠ è½½ â†’ JVM è¿è¡Œ
```

---

## **2. è¯¦ç»†è§£æå„ä¸ªé˜¶æ®µ**
### **â‘  åŠ è½½ï¼ˆLoadingï¼‰**
**ç±»åŠ è½½å™¨ä»**ï¼š
- **JAR åŒ… / .class æ–‡ä»¶**
- **ç½‘ç»œ**
- **è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ**
è¯»å–ç±»å­—èŠ‚ç ï¼Œå¹¶åˆ›å»º **`java.lang.Class`** å¯¹è±¡ã€‚

**ä»£ç ç¤ºä¾‹ï¼š**
```java
public class Test {
    static {
        System.out.println("Test ç±»åŠ è½½ï¼");
    }
}
```
æ‰§è¡Œ `Class.forName("Test")` æˆ– `new Test()` æ—¶ï¼Œç±»ä¼šè¢«åŠ è½½ã€‚

---

### **â‘¡ éªŒè¯ï¼ˆVerificationï¼‰**
**ç›®çš„ï¼šç¡®ä¿å­—èŠ‚ç æ–‡ä»¶çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„ä»£ç è¿è¡Œã€‚**
- **æ–‡ä»¶æ ¼å¼æ ¡éªŒ**ï¼ˆ.class æ–‡ä»¶æ˜¯å¦ç¬¦åˆè§„èŒƒï¼‰
- **å…ƒæ•°æ®æ ¡éªŒ**ï¼ˆç±»æ˜¯å¦ç¬¦åˆ Java è¯­æ³•ï¼‰
- **å­—èŠ‚ç æ ¡éªŒ**ï¼ˆæŒ‡ä»¤æ˜¯å¦åˆæ³•ï¼‰
- **ç¬¦å·å¼•ç”¨æ ¡éªŒ**ï¼ˆæ˜¯å¦èƒ½æ­£ç¡®è§£æï¼‰

ğŸ”¥ **å¦‚æœæ ¡éªŒå¤±è´¥ï¼ŒJVM æŠ›å‡º `java.lang.VerifyError`**ã€‚

---

### **â‘¢ å‡†å¤‡ï¼ˆPreparationï¼‰**
- ä¸º**ç±»çš„é™æ€å˜é‡** **åˆ†é…å†…å­˜**ï¼ˆä½†ä¸èµ‹å€¼ï¼‰ã€‚
- èµ‹å€¼**é»˜è®¤åˆå§‹å€¼**ï¼ˆå¦‚ `int` é»˜è®¤ä¸º `0`ï¼Œå¼•ç”¨ç±»å‹é»˜è®¤ `null`ï¼‰ã€‚
- **ä¸åŒ…æ‹¬ `static final` å˜é‡**ï¼Œå› ä¸ºå®ƒä»¬åœ¨ç¼–è¯‘æœŸå·²ç»ç¡®å®šã€‚

**ç¤ºä¾‹ï¼š**
```java
class Test {
    static int a = 10; // åœ¨å‡†å¤‡é˜¶æ®µï¼Œa = 0
}
```
**å‡†å¤‡é˜¶æ®µï¼š** `a = 0`ï¼ˆé»˜è®¤å€¼ï¼‰  
**åˆå§‹åŒ–é˜¶æ®µï¼š** `a = 10`ï¼ˆèµ‹å€¼ï¼‰

---

### **â‘£ è§£æï¼ˆResolutionï¼‰**
- **ç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referenceï¼‰** â†’ **ç›´æ¥å¼•ç”¨ï¼ˆDirect Referenceï¼‰**
- **ä¾‹å¦‚ï¼š**
  - `String.class` â†’ `"java/lang/String"`
  - `Method.invoke()` â†’ æ–¹æ³•åœ°å€

ğŸ”¥ **å¦‚æœè§£æå¤±è´¥ï¼ˆç±»æ‰¾ä¸åˆ°ï¼‰ï¼ŒæŠ›å‡º `NoClassDefFoundError` æˆ– `ClassNotFoundException`**ã€‚

---

### **â‘¤ åˆå§‹åŒ–ï¼ˆInitializationï¼‰**
- **æ‰§è¡Œé™æ€å˜é‡èµ‹å€¼å’Œ `static {}` ä»£ç å—**ã€‚
- åªæœ‰**çœŸæ­£ä½¿ç”¨**ç±»æ—¶æ‰ä¼šè§¦å‘ï¼ˆæ‡’åŠ è½½ï¼‰ã€‚
- **åˆå§‹åŒ–é¡ºåº**ï¼š
  1. **çˆ¶ç±»é™æ€ä»£ç å—**
  2. **çˆ¶ç±»é™æ€å˜é‡**
  3. **å­ç±»é™æ€ä»£ç å—**
  4. **å­ç±»é™æ€å˜é‡**

**ç¤ºä¾‹ï¼š**
```java
class Parent {
    static int a = 10;
    static { System.out.println("Parent åˆå§‹åŒ–"); }
}
class Child extends Parent {
    static int b = 20;
    static { System.out.println("Child åˆå§‹åŒ–"); }
}
public class Test {
    public static void main(String[] args) {
        System.out.println(Child.b);
    }
}
```
**è¾“å‡ºï¼š**
```
Parent åˆå§‹åŒ–
Child åˆå§‹åŒ–
20
```

---

## **3. ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰**
JVM æä¾› **åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParent Delegation Modelï¼‰**ï¼Œå¸¸è§çš„ç±»åŠ è½½å™¨ï¼š
| **ç±»åŠ è½½å™¨** | **ä½œç”¨** |
|-------------|---------|
| **BootstrapClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰** | åŠ è½½ **`java.lang.*`ï¼ˆå¦‚ String, Objectï¼‰**ï¼ŒC++ å®ç° |
| **ExtClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰** | åŠ è½½ `JDK/lib/ext/*.jar` |
| **AppClassLoaderï¼ˆåº”ç”¨ç±»åŠ è½½å™¨ï¼‰** | åŠ è½½ `classpath` ä¸‹çš„ç±» |
| **è‡ªå®šä¹‰ ClassLoader** | å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ |

ğŸ”¥ **åŒäº²å§”æ´¾æœºåˆ¶ï¼š**  
- **å…ˆäº¤ç»™çˆ¶ç±»åŠ è½½å™¨**ï¼Œå¦‚æœçˆ¶ç±»æ‰¾ä¸åˆ°æ‰è‡ªå·±åŠ è½½ã€‚
- é¿å…**é‡å¤åŠ è½½**å’Œ**æ ¸å¿ƒç±»è¢«ç¯¡æ”¹**ã€‚

---

## **4. ä»£ç ç¤ºä¾‹ï¼ˆè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼‰**
```java
import java.io.*;

public class MyClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] data = loadClassData(name);
            return defineClass(name, data, 0, data.length);
        } catch (IOException e) {
            throw new ClassNotFoundException();
        }
    }

    private byte[] loadClassData(String name) throws IOException {
        FileInputStream fis = new FileInputStream(name.replace(".", "/") + ".class");
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        int b;
        while ((b = fis.read()) != -1) {
            bos.write(b);
        }
        return bos.toByteArray();
    }
}
```
**è°ƒç”¨ï¼š**
```java
ClassLoader myLoader = new MyClassLoader();
Class<?> clazz = myLoader.loadClass("com.example.Test");
```

---

## **5. ä½•æ—¶ä¼šè§¦å‘ç±»åŠ è½½ï¼Ÿ**
ğŸ”¹ **ä»¥ä¸‹æƒ…å†µä¼šè§¦å‘ç±»åˆå§‹åŒ–ï¼ˆç±»çš„ä¸»åŠ¨ä½¿ç”¨ï¼‰ï¼š**
1. `new`ã€`Class.forName("XXX")`
2. **è®¿é—®ç±»çš„é™æ€å˜é‡**æˆ–**è°ƒç”¨é™æ€æ–¹æ³•**
3. è¿è¡Œ **å­ç±»** æ—¶ï¼Œçˆ¶ç±»ä¼šå…ˆåŠ è½½
4. åå°„è°ƒç”¨ `Class.newInstance()`

ğŸ”¸ **ä¸ä¼šè§¦å‘ç±»åˆå§‹åŒ–ï¼ˆç±»çš„è¢«åŠ¨å¼•ç”¨ï¼‰ï¼š**
1. **è®¿é—®å¸¸é‡**ï¼ˆ`static final` ç¼–è¯‘æœŸç¡®å®šï¼‰
2. **é€šè¿‡æ•°ç»„å®šä¹‰å¼•ç”¨**ï¼ˆ`Test[] arr = new Test[10]`ï¼‰
3. é€šè¿‡ **ClassLoader** ä»…åŠ è½½ç±»ï¼Œä¸åˆå§‹åŒ–

---

## **6. ç±»åŠ è½½æœºåˆ¶æ€»ç»“**
1. **ç±»åŠ è½½è¿‡ç¨‹**ï¼š
   - **åŠ è½½ â†’ éªŒè¯ â†’ å‡†å¤‡ â†’ è§£æ â†’ åˆå§‹åŒ–**
   - é‡ç‚¹ï¼š`static` å˜é‡ & `static{}` åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œ

2. **ç±»åŠ è½½å™¨**ï¼š
   - **BootstrapClassLoader**ï¼ˆåŠ è½½æ ¸å¿ƒç±»ï¼‰
   - **ExtClassLoader**ï¼ˆåŠ è½½ `ext/*.jar`ï¼‰
   - **AppClassLoader**ï¼ˆåŠ è½½ `classpath`ï¼‰
   - **è‡ªå®šä¹‰ ClassLoader**ï¼ˆç”¨äºçƒ­åŠ è½½ã€åŠ¨æ€ä»£ç†ï¼‰

3. **åŒäº²å§”æ´¾æ¨¡å‹**ï¼š
   - **å…ˆäº¤ç»™çˆ¶ç±»åŠ è½½å™¨**ï¼Œé¿å…é‡å¤åŠ è½½ & ä¿æŠ¤ Java æ ¸å¿ƒç±»

---

## **7. å…¸å‹é¢è¯•é¢˜**
âœ… **ç±»çš„ç”Ÿå‘½å‘¨æœŸæœ‰å“ªäº›é˜¶æ®µï¼Ÿ**
â¡ **åŠ è½½ â†’ éªŒè¯ â†’ å‡†å¤‡ â†’ è§£æ â†’ åˆå§‹åŒ–**

âœ… **å“ªäº›æƒ…å†µä¼šè§¦å‘ç±»åŠ è½½ï¼Ÿ**
â¡ **è®¿é—®é™æ€å˜é‡ã€åˆ›å»ºå®ä¾‹ã€åå°„ã€å­ç±»åŠ è½½**

âœ… **ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ**
â¡ **ç±»åŠ è½½å™¨ä¼šå…ˆå§”æ´¾ç»™çˆ¶ç±»åŠ è½½ï¼Œé¿å…é‡å¤åŠ è½½**

âœ… **å¦‚ä½•ç ´ååŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ**
â¡ **é‡å†™ `loadClass()` æˆ– `findClass()`**

---

## **8. æ€»ç»“**
- **ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼šåŠ è½½ â†’ è¿æ¥ï¼ˆéªŒè¯ã€å‡†å¤‡ã€è§£æï¼‰ â†’ åˆå§‹åŒ–**
- **`static` å˜é‡å’Œ `static{}` åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œ**
- **JVM æä¾› `Bootstrap`ã€`Ext`ã€`App` ä¸‰ç§ ClassLoader**
- **åŒäº²å§”æ´¾æ¨¡å‹** ä¿è¯ **ç±»å®‰å…¨**ï¼Œé¿å…æ ¸å¿ƒç±»è¢«ç¯¡æ”¹
- **è‡ªå®šä¹‰ ClassLoader** é€‚ç”¨äº **çƒ­åŠ è½½** å’Œ **æ’ä»¶æœºåˆ¶**

ğŸ’¡ **ç†è§£ç±»åŠ è½½æœºåˆ¶ï¼Œå¯¹ JVM è°ƒä¼˜ã€ClassLoader è®¾è®¡ã€åå°„æœºåˆ¶ã€åŠ¨æ€ä»£ç†ç­‰éå¸¸é‡è¦ï¼**