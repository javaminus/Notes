## Redis 分布式锁怎么实现？

---

### 1. 基本实现方式（SETNX + EXPIRE）

- 利用 Redis 的 `SETNX`（Set if Not Exists）命令实现加锁，只有一个客户端能成功设置 Key，其他客户端加锁失败。
- 设置锁时需同时设置过期时间，避免死锁。可用如下命令实现原子性加锁和过期：

  ```shell
  SET lock_key unique_value NX EX 10
  ```

  - `lock_key`：锁的 Key
  - `unique_value`：每个客户端唯一标识（如 UUID），用于解锁校验
  - `NX`：仅当 key 不存在时才设置
  - `EX 10`：过期时间 10 秒，防止死锁

---

### 2. 解锁实现

- 解锁时要确保只能释放自己加的锁。需校验 `lock_key` 的 value 与自己的 `unique_value` 是否一致，防止误删他人锁。
- 推荐用 Lua 脚本实现原子校验与删除：

  ```lua
  if redis.call("get", KEYS[1]) == ARGV[1] then
      return redis.call("del", KEYS[1])
  else
      return 0
  end
  ```

---

### 3. 存在的问题

- 单点 Redis 挂机，锁失效，无法保证真正的分布式高可用。
- Redis 主从同步延迟，可能出现锁失效（如主挂了，切换到从，锁可能丢失）。

---

### 4. Redlock 算法（官方推荐分布式锁方案）

- 由 Redis 官方提出，适用于多节点（多主）Redis 部署。
- 步骤：
  1. 客户端同时向 N 个独立 Redis 节点请求加锁（用 SET 命令）。
  2. 只要大多数（如 3/5 台）节点加锁成功，且总时延小于锁过期时间，视为加锁成功。
  3. 解锁时，向所有节点发送解锁请求。
- Redlock 能较好避免单点和主从延迟问题，提升可用性和安全性。

---

### 5. 生产建议

- 推荐用 Redisson、Lettuce 等成熟客户端，内置分布式锁实现，避免踩坑。
- Redis 分布式锁仅适合“抢占式短时锁”，不适合强一致性、长时间大事务场景。

---

### 6. 面试延伸

- 理解 SETNX + EXPIRE 实现原理及其局限性
- 了解 Redlock 算法流程和安全性分析
- 知道生产常用的 Redis 分布式锁客户端和最佳实践



## Redis 分布式锁——面试官深问问题与参考答案

---

### 1. 为什么需要分布式锁？Redis 分布式锁常见应用场景有哪些？

**参考答案：**  
分布式锁用于保证多个分布式节点对共享资源的互斥访问，避免并发冲突。常见应用场景有：秒杀库存扣减、订单幂等、定时任务分布式抢占、全局唯一ID生成等。

---

### 2. Redis 分布式锁的基本实现原理是什么？

**参考答案：**  
利用 Redis 的 SETNX 命令（或 SET key value NX EX）实现锁的唯一性和自动过期。只有第一个请求能成功加锁，其他并发请求会失败。同时设置过期时间防止死锁。

---

### 3. 如何保证分布式锁的“可重入性”与“安全释放”？

**参考答案：**  
可重入性需结合客户端唯一标识（如 UUID）判断；安全释放则要校验释放锁的客户端身份，防止误删他人锁。通常用 Lua 脚本原子判断和删除（先判断 value，再 DEL）。

---

### 4. Redis 分布式锁会遇到哪些问题？如何优化？

**参考答案：**  
常见问题有锁失效（如主从切换锁丢失）、超时未释放、误删他人锁等。优化措施有 Redlock 算法（多节点加锁）、合理设置过期时间、Lua 脚本释放锁、用成熟组件如 Redisson。

---

### 5. 请简述 Redlock 算法原理及优缺点。

**参考答案：**  
Redlock 由 Redis 官方提出，核心是客户端需在多个独立 Redis 实例上大多数节点加锁成功才算加锁成功。优点是避免单点失效，提升可靠性；缺点是实现复杂，网络分区时理论上仍有一致性风险，部分社区有争议。

---

### 6. 使用 Redis 分布式锁与基于数据库的分布式锁相比有何区别？

**参考答案：**  
Redis 锁性能高，支持高并发，自动过期机制好；数据库锁实现简单但性能差，易造成阻塞和死锁。Redis 锁适合读多写少、低延迟场景，数据库锁适合强一致性需求。

---

### 7. 分布式锁过期时间如何设置？会有哪些影响？

**参考答案：**  
过期时间需大于业务执行的最长时间，太短可能导致锁提前释放；太长则增加死锁风险。可采用“看门狗”机制自动续期，避免锁意外失效。

---

### 8. Redis 分布式锁适合哪些业务场景？不适合哪些场景？

**参考答案：**  
适合短时、低并发的互斥控制，不适合强一致性、高可靠性要求的大事务场景或长时间持有锁的业务。

---

### 9. Redis 单节点与集群下分布式锁实现有何不同？

**参考答案：**  
单节点锁实现简单但有单点风险；集群/多主环境下推荐 Redlock 算法，减少因单节点宕机导致的锁失效，提升可用性和安全性。

---

### 10. 生产环境下推荐用什么分布式锁组件？为什么？

**参考答案：**  
推荐用 Redisson、Lettuce 等开源库，内置安全、可重入、自动续期和高可用支持，避免自己造轮子踩坑。

---

---