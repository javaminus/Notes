## 问题：Redis 的压缩列表（Ziplist）和跳表（Skiplist）是什么？它们在 Redis 中分别有哪些应用？

### 1. 压缩列表（Ziplist）

**原理简介：**
- 压缩列表是一种高效、紧凑的连续内存数据结构，本质上是一个连续的字节数组，用于节省内存。
- 每个节点存储数据及前后节点长度信息，支持顺序遍历。
- 适合存储小规模、元素较小、插入删除不频繁的场景。

**在 Redis 中的应用：**
- **List 类型底层实现之一**：当一个 List 较短且元素较小（默认元素数 < 512，元素 < 64 字节），Redis 用 ziplist 存储，实现极致节省内存。
- **Hash、ZSet 的底层编码之一**：小型 Hash（字段和值都较小、数量不多）和小型有序集合 ZSet 也会采用 ziplist 编码。

**优缺点：**
- 优点：极致节省内存，顺序遍历高效。
- 缺点：插入、删除复杂度高，扩展需整体移动数据，不适合大数据量/频繁变更场景。

**通俗例子：**
像地铁车厢里一排排紧挨着坐的人，省空间但要插进/移出某个人，得让整排人挪动位置。

---

### 2. 跳表（Skiplist）

**原理简介：**
- 跳表是一种有序数据结构，支持快速查找、插入和删除，时间复杂度 O(logN)。
- 每个节点有多层索引，越上层索引跨度越大，实现“跳跃式”查找。
- 适用于有序集合和需要范围查找的数据结构。

**在 Redis 中的应用：**
- **ZSet（有序集合）底层实现之一**：当有序集合元素较多时，Redis 采用跳表（和哈希表组合）实现，支持高效范围查找、分数排序、区间操作等。
- 跳表保证有序性，查找和插入性能类似平衡树，但实现更简单。

**优缺点：**
- 优点：查找、插入、删除效率高，实现简单，支持范围查找和有序遍历。
- 缺点：比简单链表或数组略耗内存；极端情况下性能略低于红黑树等，但实际表现优秀。

**通俗例子：**
像多层立交桥，不仅可以一层一层走（链表），还可以直接走高架（索引层）跨越很多路口，查找和通行更快。

---

### 总结性回答（复习提示）

- **压缩列表（ziplist）**：节省内存的小型线性存储结构，常用于小 List、Hash、ZSet。
- **跳表（skiplist）**：高效有序数据结构，支持范围查找和排序，主要用于 ZSet 大数据量场景。



## Redis 压缩列表（Ziplist）与跳表（Skiplist）——面试官深问问题与参考答案

---

### 1. 压缩列表和链表/数组有什么区别？为什么 Redis 要用 Ziplist？

**参考答案：**  
压缩列表是将所有元素紧密存储到一段连续内存中，极大地节省了内存空间。与链表相比，没有指针开销，适用于小数据量场景；与数组相比，插入删除不是 O(1)，需要移动数据。Redis 选择 ziplist 是为了在小对象场景下实现极致内存优化，提升缓存效率。

---

### 2. Ziplist 什么时候会被自动转换为 Linkedlist/Hashtable/Skiplist？

**参考答案：**  
当 List、Hash、ZSet 的元素数量或单个元素长度超过阈值（如 list-max-ziplist-entries、list-max-ziplist-value），Redis 会自动将底层编码从 ziplist 转换为更适合大数据量和高频操作的数据结构，如 Linkedlist（List）、Hashtable（Hash）、Skiplist+Hashtable（ZSet），以保证操作效率。

---

### 3. 跳表和红黑树相比，有什么优劣？为什么 Redis 选用跳表实现 ZSet？

**参考答案：**  
跳表实现简单、支持快速范围查找，便于有序遍历，性能接近红黑树；跳表插入、删除无需复杂旋转操作，易于实现链式存储，内存局部性好。Redis 选用跳表主要因为其实现简单、扩展灵活、插入和区间操作高效，能很好支持 ZSet 的排序和范围检索等功能。

---

### 4. Redis ZSet 为什么要用 Skiplist 和 HashTable 双结构实现？

**参考答案：**  
HashTable 通过成员名快速定位节点，实现 O(1) 查找和删除；Skiplist 通过分数有序存储，支持 O(logN) 排序、范围查询、排名等操作。两者结合既保证了有序性，又兼顾高效的成员定位和区间检索，提升整体性能。

---

### 5. Ziplist 有哪些典型的内存局限和风险？

**参考答案：**  
由于采用连续内存，插入/删除大数据时需整体移动元素，效率低下。数据量大时整体 reallocate 可能导致内存碎片、阻塞甚至 OOM。极端情况下 ziplist 也可能被数据破坏导致崩溃，所以只适合小数据量、低变更场景。

---

### 6. 跳表在 Redis 查询区间、排名、分页时如何发挥作用？

**参考答案：**  
跳表天然有序，支持高效的范围查找（如 ZRANGEBYSCORE）、排名查询（如 ZRANK）、区间删除（如 ZREMRANGEBYRANK），这些都是通过跳表的多层索引结构实现的，能保证操作的高性能和有序性。

---

### 7. Redis 7.0 之后，Ziplist 有哪些变化或替代方案？

**参考答案：**  
Redis 7.0 后，Ziplist 被 Listpack 替代。Listpack 更高效、结构更简单，解决了 ziplist 某些边界条件下的内存和安全问题。应用场景与 ziplist 类似，主要用于小型 List、Hash、ZSet 的底层编码。

---

## 总结

面试深问时，需掌握 Ziplist/Skiplist 的底层原理、适用场景、优缺点，以及 Redis 在实际应用中的自动切换和优化设计。