# 外卖系统：一天一千万数据，需查30天数据的表设计方案

## 题目要点
- 每天 1000 万数据，30 天热数据共 3 亿
- 用户、商家均需按自身维度查近 30 天订单
- 仅查 30 天数据，30 天外数据可归档

---

## 设计思路

### 1. **冷热数据分离**
- 近 30 天数据为“热数据”，单独存储，支持高效查询
- 30 天外数据归档（归档表或冷库），主库无需频繁查询

### 2. **分库分表**
- 3 亿量级，单表存储和查询压力极大，必须分库分表
- 分表建议：**买家 ID 分表**，如分成 64 张表，单表约 500 万数据

#### 表结构示例（买家维度）

```sql
CREATE TABLE orders_x (
    order_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    buyer_id BIGINT NOT NULL,
    seller_id BIGINT NOT NULL,
    order_date DATETIME NOT NULL,
    amount DECIMAL(10,2),
    status ENUM('Pending','Completed','Cancelled','Refunded'),
    INDEX idx_buyer_date (buyer_id, order_date)
);
-- orders_0 ~ orders_63
```

- 查询买家订单：定位分表，走联合索引高效查找

---

### 3. **卖家查询的优化**
- 直接用买家分表，卖家查会导致跨表、跨库低效
- **空间换时间**：冗余一张以卖家 ID 分表的“卖家订单表”，同步写入，专供卖家维度查询

#### 卖家分表表结构示例

```sql
CREATE TABLE orders_seller_x (
    order_id BIGINT,
    buyer_id BIGINT NOT NULL,
    seller_id BIGINT NOT NULL,
    order_date DATETIME NOT NULL,
    amount DECIMAL(10,2),
    status ENUM('Pending','Completed','Cancelled','Refunded'),
    INDEX idx_seller_date (seller_id, order_date)
);
-- orders_seller_0 ~ orders_seller_63
```

- 查询卖家订单：直接定位分表、走联合索引

---

### 4. **数据归档方案**
- 30天外历史数据定期归档到归档表/冷库（如Hadoop、冷MySQL分区等）
- 归档后主库热表体积始终控制在合理范围

---

### 5. **分布式数据库（如TiDB、OceanBase、Spanner）**
- 支持亿级数据的高效查询和分表管理，可作为基础设施选型

---

## 总结

1. **冷热数据分离**，30天内热数据高频查，30天外归档
2. **分库分表**，主表按买家分表，卖家查用冗余分表
3. **同步机制**，保持买家表、卖家表数据一致
4. **联合索引**，各自按 buyer_id+date / seller_id+date 提升查询效率
5. **分布式数据库**可选，保证扩展性与高并发

> 这样设计，能高效支撑超大数据量的多维检索，满足用户和商家的高性能订单查询需求！