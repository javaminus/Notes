# 大型电商订单系统的分库分表设计方案 🏬💡

面对订单量巨大、并发高的电商系统，如何科学设计分库分表？这是一道高频面试题，也是实际架构设计的基础功。以下整理核心思路和落地方案👇

---

## 1️⃣ 分库 VS 分表，核心区别

- **分表**：解决单表数据量过大、查询慢问题（如分散到多张表）。
- **分库**：解决数据库并发瓶颈、单库连接数/资源不足问题（如分布到多实例）。
- **分库分表**：大部分电商订单系统都会两者结合。

---

## 2️⃣ 分库分表方式

- **垂直分库/分表**：按业务模块或字段拆分（如订单库、用户库、订单主/扩展表）。
- **水平分库/分表**：按行拆分（如订单表 128 张，分布在 16 个库）。

---

## 3️⃣ 分表/分库数量怎么定？🔢

- 分表数量 ≈ `(存量订单总数 + 年增长量 × 保留年限) / 2000万`，向上取最接近的2的幂。
- 分库数量 ≈ 分表数量 / 8（经验值，可根据并发实际调整）
- 常见组合：128库1024表、64库512表、16库128表等

---

## 4️⃣ 分表字段选择 🎯

### 按时间分表
- 如：每年/每月一张表，适合历史归档、冷热数据分离
- 优点：查询、归档简单
- 缺点：热点月份有倾斜，跨时段需跨表查询

### 按买家ID分表（推荐）
- 大部分电商选用，均匀分散数据，避免卖家大户倾斜
- 卖家查询问题：通过双写/同步卖家分表解决
- 订单号查询：通过“基因法”编码分表信息到订单号里

---

## 5️⃣ 查询场景及优化

- **卖家订单查询**：单独维护卖家分表（binlog监听同步），只读不写
- **订单号查询**：订单号中编码分表信息，解析即可定位分表
- **历史查询**：归档老订单至历史表/库，减少主库压力

---

## 6️⃣ 分表算法怎么选？🔢

- **取模法**：`分表字段 % 分表数`，简单高效
- **哈希法**：字符串字段先hash再取模
- **一致性哈希**：适合动态扩容，但实际用得较少

---

## 7️⃣ 典型组合拳 🥊

- 主库按买家ID分表，同步卖家分表库
- 订单号采用“基因法”编码分表信息
- 老订单定期归档，冷热分离
- 查询时优先带分表字段，避免扫描全表

---

## ✅ 总结

- 分库解决**并发瓶颈**，分表解决**大数据量问题**
- 分表字段选“买家ID”为主，“时间”辅助做归档
- 分表算法追求简单（取模/哈希）
- 查询优化通过双分表/订单号基因法配合
- 合理预估分表/库数量，避免频繁迁移

---

> **一句话总结：**  
> 订单系统分库分表核心在于字段设计、分表算法与冷热分离，既要抗并发又要高效查询，方案灵活组合，落地务实！🚀