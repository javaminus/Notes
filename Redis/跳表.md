### Redis ä¸­çš„è·³è¡¨ï¼ˆSkip Listï¼‰

#### 1. **è·³è¡¨æ˜¯ä»€ä¹ˆï¼Ÿ**

è·³è¡¨ï¼ˆSkip Listï¼‰æ˜¯ä¸€ç§ **åŸºäºé“¾è¡¨çš„æœ‰åºæ•°æ®ç»“æ„**ï¼Œé€šè¿‡**å¤šçº§ç´¢å¼•**æ¥åŠ é€ŸæŸ¥è¯¢ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥å¤šçº§ç´¢å¼•ï¼Œä½¿å¾—æŸ¥æ‰¾æ•ˆç‡ä» O(n) é™ä½åˆ° O(log n)ã€‚

#### 2. **Redis ä¸ºä»€ä¹ˆä½¿ç”¨è·³è¡¨ï¼Ÿ**

åœ¨ Redis ä¸­ï¼Œè·³è¡¨è¢«ç”¨äºå®ç° **æœ‰åºé›†åˆï¼ˆSorted Setï¼Œzsetï¼‰**ï¼Œç‰¹åˆ«æ˜¯å½“ï¼š

- éœ€è¦èŒƒå›´æŸ¥è¯¢ï¼ˆä¾‹å¦‚ `ZRANGE`ï¼‰
- éœ€è¦æŒ‰åˆ†æ•°æ’åºï¼ˆscoreï¼‰
- éœ€è¦é«˜æ•ˆæ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œ

ç›¸æ¯”äº **çº¢é»‘æ ‘**ï¼Œè·³è¡¨å®ç°æ›´ç®€å•ï¼Œæ€§èƒ½ç›¸å½“ï¼Œå¹¶ä¸”æ”¯æŒ**é¡ºåºæ€§æŸ¥è¯¢**ï¼Œå› æ­¤è¢« Redis é‡‡ç”¨ã€‚

#### 3. **è·³è¡¨çš„ç»“æ„**

è·³è¡¨çš„ç»“æ„ç±»ä¼¼äºå¤šä¸ªå±‚å çš„é“¾è¡¨ï¼š

- **åº•å±‚** æ˜¯ä¸€ä¸ªæ™®é€šçš„æœ‰åºé“¾è¡¨
- **ä¸Šå±‚** æ˜¯ç´¢å¼•å±‚ï¼Œæ¯ä¸€å±‚çš„å…ƒç´ æ˜¯ä¸‹å±‚å…ƒç´ çš„å­é›†ï¼Œæä¾›è·³è·ƒè®¿é—®èƒ½åŠ›
- **å¤´ç»“ç‚¹** è¿æ¥æ‰€æœ‰ç´¢å¼•å±‚ï¼Œæœ€é«˜ç´¢å¼•å±‚å¯ä»¥å¿«é€Ÿè·³è·ƒåˆ°è¿œå¤„çš„å…ƒç´ 

ä¾‹å¦‚ï¼š

```
Level 3:     [4] ---------> [16] -------> [32]
Level 2:     [4] ----> [8] ----> [16] --> [24] --> [32]
Level 1: [1] -> [4] -> [6] -> [8] -> [12] -> [16] -> [20] -> [24] -> [28] -> [32]
```

#### 4. **è·³è¡¨æ“ä½œçš„æ—¶é—´å¤æ‚åº¦**

- **æŸ¥è¯¢ï¼ˆæŸ¥æ‰¾æŸä¸ªå…ƒç´ ï¼‰**ï¼šO(log n)
- **æ’å…¥**ï¼šO(log n)
- **åˆ é™¤**ï¼šO(log n)
- **èŒƒå›´æŸ¥è¯¢**ï¼šO(log n + k)ï¼ˆk æ˜¯æŸ¥è¯¢èŒƒå›´å†…çš„å…ƒç´ ä¸ªæ•°ï¼‰

#### 5. **Redis ä¸­çš„è·³è¡¨å®ç°**

Redis ä½¿ç”¨ `zskiplist` ç»“æ„æ¥å®ç°è·³è¡¨ï¼Œå…¶ä¸­ï¼š

- **èŠ‚ç‚¹ï¼ˆzskiplistNodeï¼‰** å­˜å‚¨ `score`ï¼ˆåˆ†æ•°ï¼‰ å’Œ `obj`ï¼ˆæˆå‘˜å€¼ï¼‰
- **å¤´ç»“ç‚¹ï¼ˆheaderï¼‰** å­˜å‚¨å¤šä¸ªç´¢å¼•å±‚
- **å°¾ç»“ç‚¹ï¼ˆtailï¼‰** ä¾¿äºä»å³å‘å·¦éå†
- **éšæœºå±‚çº§åˆ†é…** é‡‡ç”¨ **å¹‚æ¬¡æ³•**ï¼ˆ1/2 æ¦‚ç‡æ–°å¢ä¸€çº§ï¼‰

æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š

**ä¸­æ–‡ä»£ç è§£é‡Šï¼š**

1. **SkipListNodeç±»**ï¼šè¡¨ç¤ºè·³è¡¨çš„èŠ‚ç‚¹ï¼ŒåŒ…å«keyã€valueå’Œforwardæ•°ç»„ï¼Œforwardæ•°ç»„ä¿å­˜æ¯ä¸€å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¼•ç”¨ã€‚

2. RedisSkipListç±»

   ï¼šå®ç°è·³è¡¨çš„ä¸»è¦é€»è¾‘ï¼ŒåŒ…æ‹¬æ’å…¥ã€æŸ¥æ‰¾ã€åˆ é™¤å’Œæ‰“å°æ“ä½œã€‚

   - `MAX_LEVEL`ï¼šè·³è¡¨æœ€å¤šæ”¯æŒçš„å±‚æ•°ã€‚
   - `P`ï¼šæ¯ä¸€å±‚çš„æ¦‚ç‡ï¼Œå½±å“è·³è¡¨çš„å¹³è¡¡æ€§ã€‚
   - `level`ï¼šå½“å‰è·³è¡¨çš„å®é™…å±‚æ•°ã€‚
   - `head`ï¼šå¤´èŠ‚ç‚¹ã€‚
   - `randomLevel()`ï¼šç”¨äºéšæœºç”Ÿæˆæ–°èŠ‚ç‚¹çš„å±‚æ•°ã€‚

3. **insertæ–¹æ³•**ï¼šæ’å…¥æ–°èŠ‚ç‚¹ï¼Œå…ˆæ‰¾åˆ°æ¯ä¸€å±‚åˆé€‚çš„ä½ç½®ï¼Œç„¶ååœ¨æ¯ä¸€å±‚æ’å…¥æ–°èŠ‚ç‚¹ã€‚

4. **searchæ–¹æ³•**ï¼šæŸ¥æ‰¾æŒ‡å®škeyçš„èŠ‚ç‚¹ï¼Œé€å±‚å‘ä¸‹æŸ¥æ‰¾ã€‚

5. **deleteæ–¹æ³•**ï¼šåˆ é™¤æŒ‡å®škeyçš„èŠ‚ç‚¹ï¼Œé€å±‚æ›´æ–°forwardæŒ‡é’ˆï¼Œå¹¶è°ƒæ•´è·³è¡¨é«˜åº¦ã€‚

6. **printSkipListæ–¹æ³•**ï¼šæ‰“å°è·³è¡¨çš„æ¯ä¸€å±‚ç»“æ„ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚

7. **mainæ–¹æ³•**ï¼šç®€å•æµ‹è¯•æ’å…¥ã€æŸ¥æ‰¾å’Œåˆ é™¤åŠŸèƒ½ã€‚

è¿™ç§è·³è¡¨å®ç°ä¸Redisä¸­çš„è·³è¡¨åŸç†ç±»ä¼¼ï¼Œé€‚åˆå¯¹è·³è¡¨æ„Ÿå…´è¶£çš„å¼€å‘è€…å­¦ä¹ ã€‚

```java
import java.util.Random;

// è·³è¡¨èŠ‚ç‚¹ç±»
class SkipListNode {
    int key; // èŠ‚ç‚¹çš„key
    int value; // èŠ‚ç‚¹çš„å€¼
    SkipListNode[] forward; // æŒ‡å‘ä¸‹ä¸€å±‚èŠ‚ç‚¹çš„æ•°ç»„

    public SkipListNode(int key, int value, int level) {
        this.key = key;
        this.value = value;
        this.forward = new SkipListNode[level];
    }
}

// è·³è¡¨å®ç°
public class RedisSkipList {
    private static final int MAX_LEVEL = 16; // æœ€å¤§å±‚æ•°
    private static final double P = 0.5; // æ¯ä¸€å±‚çš„æ¦‚ç‡
    private int level = 1; // å½“å‰è·³è¡¨å±‚æ•°
    private SkipListNode head = new SkipListNode(-1, -1, MAX_LEVEL); // å¤´èŠ‚ç‚¹
    private Random random = new Random();

    // éšæœºç”Ÿæˆå±‚æ•°
    private int randomLevel() {
        int lvl = 1;
        while (random.nextDouble() < P && lvl < MAX_LEVEL) {
            lvl++;
        }
        return lvl;
    }

    // æ’å…¥èŠ‚ç‚¹
    public void insert(int key, int value) {
        SkipListNode[] update = new SkipListNode[MAX_LEVEL];
        SkipListNode x = head;
        // ä»ä¸Šåˆ°ä¸‹æœç´¢æ’å…¥ä½ç½®
        for (int i = level - 1; i >= 0; i--) {
            while (x.forward[i] != null && x.forward[i].key < key) {
                x = x.forward[i];
            }
            update[i] = x;
        }
        x = x.forward[0];

        if (x != null && x.key == key) {
            // å¦‚æœå­˜åœ¨keyï¼Œæ›´æ–°value
            x.value = value;
            return;
        }

        int lvl = randomLevel();
        if (lvl > level) {
            for (int i = level; i < lvl; i++) {
                update[i] = head;
            }
            level = lvl;
        }

        SkipListNode newNode = new SkipListNode(key, value, lvl);
        // åœ¨æ¯ä¸€å±‚æ’å…¥æ–°èŠ‚ç‚¹
        for (int i = 0; i < lvl; i++) {
            newNode.forward[i] = update[i].forward[i];
            update[i].forward[i] = newNode;
        }
    }

    // æŸ¥æ‰¾èŠ‚ç‚¹
    public Integer search(int key) {
        SkipListNode x = head;
        for (int i = level - 1; i >= 0; i--) {
            while (x.forward[i] != null && x.forward[i].key < key) {
                x = x.forward[i];
            }
        }
        x = x.forward[0];
        if (x != null && x.key == key) {
            return x.value;
        }
        return null;
    }

    // åˆ é™¤èŠ‚ç‚¹
    public void delete(int key) {
        SkipListNode[] update = new SkipListNode[MAX_LEVEL];
        SkipListNode x = head;
        for (int i = level - 1; i >= 0; i--) {
            while (x.forward[i] != null && x.forward[i].key < key) {
                x = x.forward[i];
            }
            update[i] = x;
        }
        x = x.forward[0];
        if (x != null && x.key == key) {
            for (int i = 0; i < level; i++) {
                if (update[i].forward[i] != x) break;
                update[i].forward[i] = x.forward[i];
            }
            // è°ƒæ•´è·³è¡¨å±‚æ•°
            while (level > 1 && head.forward[level - 1] == null) {
                level--;
            }
        }
    }

    // æ‰“å°è·³è¡¨
    public void printSkipList() {
        for (int i = level - 1; i >= 0; i--) {
            SkipListNode x = head.forward[i];
            System.out.print("Level " + i + ": ");
            while (x != null) {
                System.out.print("(" + x.key + "," + x.value + ") ");
                x = x.forward[i];
            }
            System.out.println();
        }
    }

    // æµ‹è¯•
    public static void main(String[] args) {
        RedisSkipList skipList = new RedisSkipList();
        skipList.insert(1, 10);
        skipList.insert(3, 30);
        skipList.insert(2, 20);
        skipList.printSkipList();

        System.out.println("æŸ¥æ‰¾key=2çš„å€¼: " + skipList.search(2));
        skipList.delete(2);
        skipList.printSkipList();
    }
}
```

#### 6. **Redis ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å¹³è¡¡æ ‘ï¼Ÿ**

- **è·³è¡¨ä»£ç å®ç°æ¯”å¹³è¡¡æ ‘ç®€å•**
- **è·³è¡¨æ”¯æŒé¡ºåºéå†ï¼Œè€Œçº¢é»‘æ ‘åªèƒ½ä¸­åºéå†**
- **Redis çš„æœ‰åºé›†åˆç»å¸¸éœ€è¦èŒƒå›´æŸ¥è¯¢ï¼Œè·³è¡¨æ›´é«˜æ•ˆ**
- **è·³è¡¨çš„æ’å…¥ã€åˆ é™¤ä¸ä¼šè§¦å‘å¤æ‚çš„æ ‘ç»“æ„è°ƒæ•´**

#### 7. **æ€»ç»“**

- Redis ç”¨è·³è¡¨ï¼ˆskip listï¼‰å®ç° **zset**ï¼Œå› ä¸ºå®ƒæ¯”çº¢é»‘æ ‘æ›´é€‚åˆèŒƒå›´æŸ¥è¯¢å’Œé¡ºåºè®¿é—®
- è·³è¡¨é€šè¿‡ **å¤šçº§ç´¢å¼•** å®ç° **O(log n) çš„æŸ¥æ‰¾æ•ˆç‡**
- Redis çš„ `zskiplist` ç»“æ„ä½¿ç”¨ **éšæœºå±‚çº§åˆ†é…**ï¼Œæé«˜è®¿é—®é€Ÿåº¦
- åœ¨ Redis é‡Œï¼Œ**zset ç”±è·³è¡¨ + å“ˆå¸Œè¡¨ ç»„æˆ**ï¼Œå“ˆå¸Œè¡¨ç”¨äº O(1) å¿«é€Ÿå®šä½ï¼Œè·³è¡¨ç”¨äºèŒƒå›´æŸ¥è¯¢

å¦‚æœä½ è¦æ·±å…¥ç ”ç©¶ Redis æºç ï¼Œå¯ä»¥ä» `zskiplist.c` å¼€å§‹åˆ†æï¼ğŸš€