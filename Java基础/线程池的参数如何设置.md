# 线程池的参数如何设置

线程池的参数设置要结合实际业务场景、机器资源和任务特点，合理配置才能兼顾性能与稳定性。下面分别介绍每个参数的设置思路和常见建议。

---

## 1. corePoolSize（核心线程数）

- **作用**：线程池中始终保留的线程数量，即使空闲也不会被销毁。
- **设置建议**：
  - **CPU密集型任务**（如加密、压缩、计算等）：  
    建议设为 `CPU核心数` 或 `CPU核心数+1`
  - **IO密集型任务**（如网络、磁盘IO、数据库访问等）：  
    建议设为 `CPU核心数 * 2` 或更大
  - 根据实际服务器CPU核数、业务并发量、响应时间等进行调整。

## 2. maximumPoolSize（最大线程数）

- **作用**：线程池允许创建的最大线程数量。
- **设置建议**：
  - 通常大于等于 corePoolSize
  - 受限于服务器资源上限（避免过多线程导致CPU切换频繁、内存溢出）
  - 可根据任务高峰期的需求适当增大，但不宜过大

## 3. keepAliveTime（线程空闲存活时间）& unit（时间单位）

- **作用**：非核心线程空闲多长时间后被回收。
- **设置建议**：
  - 常用值：几十秒~几分钟（如 30s、60s）
  - 业务波动大时可适当延长，减少频繁销毁/创建线程

## 4. workQueue（任务队列）

- **作用**：保存等待执行的任务。
- **设置建议**：
  - **有界队列**（如 ArrayBlockingQueue）：推荐生产环境使用，避免无限堆积导致OOM。
  - 队列长度根据业务高峰期并发量、服务器内存等综合考虑。
  - 典型配置：`new ArrayBlockingQueue<>(1000)`  
    （1000为并发数上限，酌情调整）

## 5. threadFactory（线程工厂）

- **作用**：定制线程创建方式，如命名、优先级等。
- **设置建议**：
  - 推荐自定义线程工厂，便于问题排查。
  - 常见写法：
    ```java
    Executors.defaultThreadFactory()
    // 或使用自定义工厂，设置线程名、是否为守护线程等
    ```

## 6. handler（拒绝策略）

- **作用**：任务无法处理时的应对措施。
- **设置建议**：
  - `AbortPolicy`（默认，抛异常）：适合对任务丢失不能容忍的场景。
  - `CallerRunsPolicy`（调用者线程执行任务）：适合降低任务提交速率的场景。
  - `DiscardPolicy`（直接丢弃）：适合任务可丢弃场景，如日志。
  - `DiscardOldestPolicy`（丢弃队列最老任务）：适合需要保证新任务高优先级的场景。

---

## 配置实例（Java）

```java
ThreadPoolExecutor threadPool = new ThreadPoolExecutor(
    8,                       // corePoolSize
    16,                      // maximumPoolSize
    60L, TimeUnit.SECONDS,   // keepAliveTime & unit
    new ArrayBlockingQueue<>(2000), // workQueue
    Executors.defaultThreadFactory(), // threadFactory
    new ThreadPoolExecutor.AbortPolicy() // handler
);
```

---

## 场景解释示例

> **高并发 Web 服务场景：**
>
> 某电商网站有一个秒杀接口，活动期间用户请求量激增。假设服务器有8核CPU，平常流量时设置 corePoolSize 为8，保证每个CPU核有一个工作线程。峰值时 maximumPoolSize 可适当提升到16，允许更高并发。workQueue 设置为2000，足以缓冲瞬时高峰。keepAliveTime 设为60秒，确保高峰过后多余线程可及时释放。拒绝策略选用 `CallerRunsPolicy`，在极端高并发下由调用者线程处理部分请求，减缓压力，避免队列积压导致系统崩溃。

---

## 复习顺口溜

> 线程池参数要合理，  
> 核心最大看任务，  
> 队列有界防溢出，  
> 拒绝策略别忘记，  
> 工厂命名调试明，  
> 存活时间有波动。

---

## 总结

- **先评估任务类型（CPU密集/IO密集）和业务并发**
- **考虑服务器CPU、内存等资源限制**
- **优先选择有界队列，合理预估队列长度**
- **根据业务容忍度选拒绝策略**
- **生产上建议自定义线程命名，便于日志排查**

如需针对某种业务场景（如高并发Web、定时任务等）给出具体配置建议，请继续提问！