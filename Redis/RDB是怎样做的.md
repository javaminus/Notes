## RDB（Redis 数据库快照）是怎样做的？

---

### RDB 持久化原理

- RDB（Redis DataBase）是 Redis 提供的一种**快照持久化机制**，可以在某个时间点将内存中的数据生成快照，保存为二进制文件（如 dump.rdb）。

---

### RDB 的工作流程

1. **触发时机**
   - 可以通过配置自动触发（如 save 900 1 表示900秒内至少1次写操作就触发快照）；
   - 也可以手动执行 `SAVE` 或 `BGSAVE` 命令。

2. **生成快照**
   - **BGSAVE**（常用）：Redis 主进程 fork 一个子进程，由子进程负责将内存数据写入 RDB 文件，主进程继续响应请求。
   - **SAVE**：主进程直接生成 RDB 文件，会阻塞服务，线上很少用。

3. **文件写入**
   - 子进程将当前所有数据序列化写入 dump.rdb 文件，原子替换旧文件。

4. **快照内容**
   - RDB 文件包含了 Redis 在某一时刻的所有数据，重启时可以用它恢复数据。

---

### 场景和特点

- **优点**：备份和恢复速度快、文件体积小、适合全量备份和迁移。
- **缺点**：无法实时持久化，可能丢失快照后产生的数据。

---

### 通俗例子

RDB 就像给账本定时拍一张“快照”，只记录快照时的账本内容，之后的变动要等下次快照才会记录。

---

### 简单命令举例

- 手动快照：`SAVE` / `BGSAVE`
- 配置快照策略：`save 900 1` `save 300 10` 等

---

## 总结

RDB 是 Redis 通过定时或手动方式，将内存数据快照持久化到磁盘的机制，适合备份和快速恢复场景，但可能丢失最近一次快照后的数据。

## Redis 持久化（RDB、AOF）——面试官深问问题与参考答案

---

### 1. RDB 和 AOF 有哪些适用场景？能否只用一种，为什么生产常常两者都开？

**参考答案：**  
RDB 适合定期备份、快速恢复，适用于对恢复速度要求高、能容忍少量数据丢失的场景。AOF 适合数据安全性要求高的场景。生产常常两者都开，RDB 定期备份，AOF 提供更高数据安全，互补优势。

---

### 2. RDB 触发时对主进程性能有什么影响？为什么用 fork 子进程？

**参考答案：**  
RDB 触发时 Redis 主进程 fork 子进程，子进程负责持久化，主进程继续处理请求。fork 会复制内存页表，短时间内消耗较大内存和 CPU，可能导致主进程卡顿，尤其数据量大时，所以生产建议合理设置持久化频率。

---

### 3. AOF 为什么会越来越大？怎么压缩？重写期间还能写入吗？

**参考答案：**  
AOF 随写操作不断追加，长期运行会变大。Redis 会自动或手动触发 AOF 重写（BGREWRITEAOF），生成精简新日志。重写采用子进程，不影响主进程写入。重写期间新操作会同时写入旧 AOF 和内存缓冲区，保证数据不丢。

---

### 4. AOF 出现损坏怎么办？数据还能恢复吗？

**参考答案：**  
AOF 是文本格式，可用 redis-check-aof 工具修复损坏部分。修复后可能丢失部分数据，但主结构能恢复。AOF 也可人工编辑，具有一定的容错性。

---

### 5. RDB/AOF 的一致性和完整性如何保证？有没有可能丢数据？

**参考答案：**  
RDB 只能保证快照时刻的数据，快照后到宕机间的数据会丢失。AOF 可配置同步策略（always/everysec/no），everysec 最常用，最多丢 1 秒数据。极端情况下（如操作系统崩溃），仍可能有数据丢失风险。

---

### 6. Redis 主从复制能否代替持久化？有何根本区别？

**参考答案：**  
主从复制用于高可用、分布式读写，不能保证数据永久保存。持久化用于数据落地，宕机后可恢复。两者功能不同，不能互相替代，需配合使用。

---

### 
