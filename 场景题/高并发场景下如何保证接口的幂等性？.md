## 高频高并发面试题 —— “高并发场景下如何保证接口的幂等性？”

### 问题
在高并发系统中，如何设计和实现接口的幂等性？请详细说明幂等性的含义、常见场景、实现方法，并结合实际例子说明如何避免因重复请求导致的数据异常。

---

### 详细解释

#### 1. 幂等性定义

**幂等性**（Idempotency）：  
指同一个操作被执行一次和执行多次，对系统产生的效果是一样的。换句话说，无论用户对同一资源发起多少次相同的请求，结果都不会改变。

#### 2. 典型高并发场景

- **支付回调**：支付平台可能多次回调商户接口，必须保证重复回调只影响一次业务。
- **订单创建**：用户因网络原因重复点击“提交订单”，系统要避免生成多个重复订单。
- **消息重试**：分布式系统中消息消费可能失败重试，处理逻辑要避免重复消费带来的数据混乱。

#### 3. 常见实现方式

- **唯一请求号（幂等号）机制**
  - 客户端为每次操作生成唯一标识（如UUID、雪花ID），服务端用此标识做去重处理。
  - 服务端接到请求时，先判断该幂等号是否已处理，已处理则直接返回结果，否则正常处理并记录此幂等号。

- **数据库唯一约束**
  - 在数据库层面对某些字段加唯一索引，比如订单号唯一，重复插入会报错，业务层捕获异常做相应处理。

- **token机制**
  - 先申请token，消费时校验token有效性，消费后即失效，保证只消费一次。

- **乐观锁/版本号控制**
  - 通过数据版本号（如update时带where version=xxx）保证同一数据只被成功修改一次。

#### 4. 实际例子

比如“双十一”秒杀活动，用户因网络卡顿多次点击“立即抢购”，前端每次请求生成唯一幂等号，后端接收到请求后，先查幂等号表，如果已存在则直接返回之前的处理结果，否则正常扣减库存、创建订单，最后记录此次幂等号。

#### 5. 注意事项

- 幂等性设计不能影响接口性能，幂等号存储推荐用高性能缓存（如Redis）。
- 幂等号的生命周期要合理设置，避免内存/存储泄漏。
- 有些业务天然幂等（如GET查询），有些需要额外支持（如POST、PUT）。

---

### 总结性回答（复习提示词）

- **幂等性含义**：同一操作多次执行结果相同  
- **场景**：支付回调、订单创建、消息消费  
- **常用方案**：唯一请求号（幂等号）、数据库唯一约束、token机制、乐观锁  
- **高并发建议**：前端生成幂等号，后端Redis/DB去重，注意性能与存储清理

> 记忆口诀：幂等号防重复，唯一约束保安全，token一次性，版本号控并发