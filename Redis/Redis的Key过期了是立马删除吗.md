## Redis 的 Key 过期了是立马删除吗？

不是。Redis 的 Key 过期后**不会立即删除**，而是采用了「惰性删除」和「定期删除」相结合的策略。

---

### 1. 惰性删除（Lazy Deletion）

- 当你访问一个 key 时（如 get/set），Redis 会先检查该 key 是否过期。
- 如果已过期，才会真正删除，并返回 nil。
- 如果没访问，过期的 key 可能还留在内存中。

---

### 2. 定期删除（Periodic Deletion）

- Redis 会周期性随机抽取部分设置了过期时间的 key，检查并删除已过期的 key。
- 这样可以清理掉部分没有被访问但已经过期的 key，防止内存泄漏。

---

### 3. 总结

- **Redis 并不会在 key 到期的那一刻立刻删除 key。**
- 过期 key 的删除时机取决于访问触发和后台定期清理，理论上 key 过期后会在一段短时间内被清理掉，但不是绝对实时删除。

---

### 4. 补充：持久化和集群下的过期处理

- RDB/AOF 持久化时，过期 key 不会被写入快照。
- Redis 集群各节点独立处理本地 key 的过期，主从同步时只有主节点主动删除 key 后才同步删除到从节点。

---

**面试延伸：**  
面试常问 Redis 过期策略，答题时建议从“惰性+定期”两种方式、优缺点、极端情况下的内存占用、集群/持久化影响等角度全面说明。



## 本地缓存 vs Redis 缓存——面试官深问问题与参考答案

---

### 1. 本地缓存和 Redis 缓存结合使用时，如何保证数据一致性？

**参考答案：**  
本地缓存和 Redis 缓存可能出现数据不一致，比如数据更新后本地未及时失效。常见做法有：  
- 设置本地缓存较短的 TTL  
- 通过 Redis 的 Key 失效通知机制（如 Keyspace Notification）驱动本地缓存失效  
- 采用“先删除 Redis，再删除本地缓存”的双删策略，或延迟双删  
- 关键数据变更时，主动通知所有实例刷新本地缓存

---

### 2. 本地缓存和 Redis 缓存各自适合什么场景？为什么？

**参考答案：**  
本地缓存适合单机/单实例、热点数据明显、低延迟要求高的场景，访问速度极快。  
Redis 缓存适合分布式、多实例、数据需全局共享、容量大、持久化/淘汰机制灵活的场景。  
两者结合可兼顾性能与一致性，常用于高并发分布式系统。

---

### 3. 本地缓存的容量如何设计？如何防止内存溢出？

**参考答案：**  
本地缓存容量应结合机器物理内存、应用负载和 GC 压力综合设计。推荐使用如 Caffeine、Guava Cache 等支持 LRU、LFU、容量限制和过期机制的成熟组件，并定期监控缓存命中率和内存使用，合理设置最大容量，防止 OOM。

---

### 4. 本地缓存和 Redis 缓存各自有哪些淘汰策略？会产生什么副作用？

**参考答案：**  
本地缓存淘汰策略常用 LRU、LFU、FIFO，由应用控制。Redis 支持多种淘汰策略如 LRU、LFU、TTL 过期、随机淘汰等。淘汰策略不合理可能导致热点数据频繁被剔除，缓存命中率下降。

---

### 5. 本地缓存如何防止缓存雪崩？和 Redis 缓存有什么不同？

**参考答案：**  
本地缓存雪崩影响仅限单实例，通常通过设置不同的过期时间、预加载或异步更新等方式防护；Redis 雪崩会影响所有实例，需通过分布式部署、限流降级等措施综合治理。

---

### 6. 为什么本地缓存不适合做分布式锁？分布式锁方案如何选型？

**参考答案：**  
本地缓存仅在单实例生效，无法实现多节点互斥，不能保证分布式一致性。分布式锁需依赖 Redis、ZooKeeper、etcd 等支持全局状态管理的组件。Redis 提供 SETNX+EXPIRE、Redlock 等分布式锁方案。

---

### 7. 在高并发场景下，本地缓存与 Redis 缓存的命中率如何优化？

**参考答案：**  
优先查本地缓存，命中则返回；未命中再查 Redis 并写回本地缓存。对高频热点数据可加长本地缓存 TTL，低频数据可不缓存。定期分析缓存命中率和热点 key 分布，动态调整缓存策略。

---

### 8. 本地缓存和 Redis 缓存如何防止缓存穿透？

**参考答案：**  
可在本地缓存和 Redis 均缓存空值（如空对象），防止同一个不存在 key 重复回源数据库。对恶意高频 access，可配合布隆过滤器等方法有效防止穿透。

---

### 9. 本地缓存和 Redis 缓存的监控和告警需要关注哪些指标？

**参考答案：**  
关注本地缓存命中率、内存占用、GC 次数/耗时、热点 key 分布；  
关注 Redis 的命中率、慢查询、QPS、内存使用、主从延迟、key 数量、连接数等。及时告警可以防止系统崩溃或雪崩。

---

### 10. 本地缓存和 Redis 缓存的缺点分别有哪些？如何规避？

**参考答案：**  
本地缓存缺点：数据不共享，易不一致，扩展性差，内存有限。  
Redis 缓存缺点：网络延迟高于本地，部署和运维复杂，极端情况下会成为单点瓶颈。  
规避方式：合理设计缓存层级、失效策略、容量、监控、结合业务特性动态调整策略。

---