MySQL 中的 **间隙锁（Gap Lock）** 是 InnoDB 存储引擎 **Next-Key Locking** 机制的一部分，主要用于 **可重复读（REPEATABLE READ）隔离级别**，防止 **幻读（Phantom Read）**。

------

## 1. **间隙锁的概念**

间隙锁是**锁定索引记录之间的范围**，而不是具体的某条记录。例如：

```
SELECT * FROM users WHERE age BETWEEN 20 AND 30 FOR UPDATE;
```

- 若表中有 `age = 25` 的记录，而 `age = 22` 的数据不存在，间隙锁会锁住 `(20, 25)` 这个区间，防止其他事务在此范围内插入新数据（如 `age = 23`）。
- 这可以避免 **新插入的数据影响当前事务的查询结果**（幻读问题）。

------

## 2. **间隙锁的工作原理**

间隙锁通常和 **行锁（Record Lock）** 结合，形成 **Next-Key Lock**：

- **Next-Key Lock** = **间隙锁（Gap Lock）** + **记录锁（Record Lock）**
- 当查询范围涉及索引时，MySQL 会**锁定匹配的行**及**其前后的间隙**，避免其他事务在该范围内插入数据。

**示例 1（存在匹配记录）**

```
SELECT * FROM users WHERE age = 25 FOR UPDATE;
```

- 如果 `users` 表有 `age = 25` 这一行，MySQL 锁住该行的记录，并锁住 `(前一个值, 25]` 这个区间，防止其他事务在 25 之前的范围插入数据。

**示例 2（无匹配记录，纯间隙锁）**

```
SELECT * FROM users WHERE age = 23 FOR UPDATE;
```

- 如果 `age = 23` 的数据不存在，MySQL 只会加 **间隙锁**，锁住 `(前一个值, 23)` 这个范围，阻止新插入 `age = 23`。

------

## 3. **间隙锁的作用**

1. **防止幻读**：避免事务重复执行相同 SQL 时，结果集不同。
2. **保证一致性**：防止其他事务在当前事务范围内插入数据，影响查询逻辑。
3. **影响范围查询**：间隙锁不仅影响已存在数据，还会锁住范围，使插入变得困难。

------

## 4. **间隙锁的触发条件**

- **仅在 REPEATABLE READ 隔离级别生效（默认 MySQL 事务级别）**。
- **必须使用索引列作为查询条件**（非索引列不会触发间隙锁）。
- **使用 FOR UPDATE 或 LOCK IN SHARE MODE** 明确加锁。

**非索引列示例（不会触发间隙锁）**

```
SELECT * FROM users WHERE name = 'Alice' FOR UPDATE;
```

- `name` 不是索引时，只会加表级锁，不涉及间隙锁。

------

## 5. **如何避免间隙锁问题**

### **(1) 使用 READ COMMITTED 隔离级别**

MySQL **READ COMMITTED** 级别 **不使用间隙锁**，只使用 **行锁**，减少锁冲突：

```
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

但这样可能导致幻读。

### **(2) 使用 唯一索引 查询**

如果查询条件是 **唯一索引** 且**精确匹配**，MySQL 只会加 **行锁** 而不会加间隙锁：

```
SELECT * FROM users WHERE id = 10 FOR UPDATE;  -- id 是主键，不会加间隙锁
```

相比之下，`age` 可能是普通索引，则会触发间隙锁。

------

## 6. **总结**

| **锁类型**              | **锁住范围**            | **作用**       |
| ----------------------- | ----------------------- | -------------- |
| **行锁（Record Lock）** | 仅锁住匹配的行          | 防止该行被修改 |
| **间隙锁（Gap Lock）**  | 锁住索引间隙，不包括行  | 防止插入新数据 |
| **Next-Key Lock**       | 记录锁 + 前一个值的间隙 | 防止幻读       |

✅ **使用 READ COMMITTED 隔离级别可避免间隙锁**，但会导致幻读。
 ✅ **唯一索引精确查询只会加行锁，不加间隙锁**，减少锁冲突。

------

这样，你就掌握了 **MySQL 间隙锁的原理** 和 **避免方法**！🚀