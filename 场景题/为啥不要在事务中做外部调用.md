# 为什么不要在事务中做外部调用？

很多开发场景下，会在数据库事务中做一些网络/外部服务调用，比如更新 Redis、发送 MQ 消息、RPC 调用等，其实非常不推荐这做法。

## 典型问题

### 1. 增加事务持续时间

- 外部网络调用会显著增加事务执行时间（如网络延迟、外部服务响应慢）。
- 持有事务和数据库连接的时间变长，影响数据库并发和整体性能。

### 2. 死锁和资源竞争

- 长时间持有事务期间的锁资源，增加死锁和锁冲突风险，尤其系统负载高时。
- 如 `select for update` 等操作，锁需等事务提交/回滚后才能释放。

### 3. 提高事务失败风险

- 外部调用增加事务失败概率（如外部服务超时/异常）。
- 外部调用失败导致整个事务回滚，可能导致核心数据操作不合理地被回滚。

> 例如：下单成功后需发MQ消息，若MQ发送失败导致订单事务回滚，用户下单失败，影响业务。

### 4. 难以保证原子性

- 事务要求原子性（要么全部成功，要么全部失败）。
- 外部系统操作难以回滚，无法保证数据库和外部系统操作的一致性。
- 网络异常时，本地事务回滚，但外部调用可能已经执行成功，导致数据不一致。

---

## 推荐做法

- **事务和外部调用分离**：事务提交后再执行外部调用，减少事务时间和失败风险。
- **补偿事务**：如需紧密集成，设计补偿逻辑撤销外部操作，确保一致性。
- **异步处理**：使用消息队列或事件驱动架构，异步执行外部调用，不阻塞数据库事务。

---

> 总结：不要在事务中做外部调用，能显著提升系统健壮性、性能和数据一致性。